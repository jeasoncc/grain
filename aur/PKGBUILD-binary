# Maintainer: Jeason <xiaomiquan@aliyun.com>
# Local test version - uses pre-built binary

pkgname=grain
pkgver=0.1.426
pkgrel=1
pkgdesc="A minimalist writing sanctuary for long-form content"
arch=('x86_64')
url="https://github.com/jeasoncc/grain"
license=('MIT')
depends=(
  'webkit2gtk'
  'gtk3'
  'libappindicator-gtk3'
)

# Use local pre-built files
source=()
sha256sums=()
noextract=()

package() {
  # Get project root from environment variable (set by test script)
  # If not set, infer from startdir
  local project_root="${PROJECT_ROOT:-$startdir/..}"
  local build_dir="$project_root/apps/desktop/src-tauri/target/release"
  
  if [ ! -f "$build_dir/$pkgname" ]; then
    error "Binary not found: $build_dir/$pkgname"
    error "Please run: ./scripts/test-local-build.sh first"
    return 1
  fi
  
  # Install binary
  install -Dm755 "$build_dir/$pkgname" \
    "$pkgdir/usr/bin/$pkgname"
  
  # Install desktop file
  install -Dm644 "$startdir/grain.desktop" \
    "$pkgdir/usr/share/applications/$pkgname.desktop"
  
  # Install icons
  local icon_dir="$project_root/apps/desktop/src-tauri/icons"
  for size in 32 128 256; do
    if [ -f "$icon_dir/${size}x${size}.png" ]; then
      install -Dm644 "$icon_dir/${size}x${size}.png" \
        "$pkgdir/usr/share/icons/hicolor/${size}x${size}/apps/$pkgname.png"
    fi
  done
  
  # Install license
  if [ -f "$project_root/LICENSE" ]; then
    install -Dm644 "$project_root/LICENSE" \
      "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
  fi
  
  # Install documentation
  if [ -f "$project_root/README.md" ]; then
    install -Dm644 "$project_root/README.md" \
      "$pkgdir/usr/share/doc/$pkgname/README.md"
  fi
}
