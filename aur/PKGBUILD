# Maintainer: Jeason <xiaomiquan@aliyun.com>

pkgname=grain
pkgver=0.1.580
pkgrel=1
pkgdesc="A minimalist writing sanctuary for long-form content"
arch=('x86_64')
url="https://github.com/jeasoncc/grain"
license=('MIT')
depends=(
  'webkit2gtk'
  'gtk3'
  'libappindicator-gtk3'
)
makedepends=(
  'rust'
  'cargo'
  'bun'
  'nodejs'
  'patchelf'
)
optdepends=(
  'libfuse2: AppImage support'
)
source=(
  "$pkgname-$pkgver.tar.gz::https://github.com/jeasoncc/$pkgname/archive/refs/tags/desktop-v$pkgver.tar.gz"
)
sha256sums=('SKIP')

prepare() {
  cd "$srcdir/$pkgname-$pkgver"
  
  # Install dependencies
  bun install
}

build() {
  cd "$srcdir/$pkgname-$pkgver"
  
  # Install desktop dependencies
  cd apps/desktop
  bun install
  
  # Build frontend
  bun run build
  
  # Build Tauri app (binary only, no bundle)
  bun run tauri build --bundles none
}

package() {
  cd "$srcdir/$pkgname-$pkgver"
  
  # Install binary
  install -Dm755 "apps/desktop/src-tauri/target/release/$pkgname" \
    "$pkgdir/usr/bin/$pkgname"
  
  # Install desktop file
  install -Dm644 "aur/$pkgname.desktop" \
    "$pkgdir/usr/share/applications/$pkgname.desktop"
  
  # Install icons
  for size in 32 128 256; do
    install -Dm644 "apps/desktop/src-tauri/icons/${size}x${size}.png" \
      "$pkgdir/usr/share/icons/hicolor/${size}x${size}/apps/$pkgname.png"
  done
  
  # Install license
  install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
  
  # Install documentation
  install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
}
