# Maintainer: Jeason <xiaomiquan@aliyun.com>
# æœ¬åœ°æµ‹è¯•ç‰ˆæœ¬ - ä½¿ç”¨æœ¬åœ°æºä»£ç 

pkgname=novel-editor
pkgver=0.1.0
pkgrel=1
pkgdesc="ä¸€æ¬¾ä¸“ä¸ºå°è¯´åˆ›ä½œè€…è®¾è®¡çš„ç°ä»£åŒ–å†™ä½œå·¥å…·"
arch=('x86_64')
url="https://github.com/jeasoncc/novel-editor"
license=('MIT')
depends=(
  'webkit2gtk'
  'gtk3'
  'libappindicator-gtk3'
)
makedepends=(
  'rust'
  'cargo'
  'nodejs'
  'patchelf'
)
# æ³¨æ„ï¼šbun éœ€è¦æ‰‹åŠ¨å®‰è£…ï¼Œä¸åœ¨å®˜æ–¹ä»“åº“ä¸­
optdepends=(
  'libfuse2: ç”¨äº AppImage æ”¯æŒ'
)

# æœ¬åœ°æµ‹è¯•ï¼šä¸ä»ç½‘ç»œä¸‹è½½
source=()
sha256sums=()

prepare() {
  # ä½¿ç”¨å½“å‰ç›®å½•çš„æºä»£ç 
  echo "ä½¿ç”¨æœ¬åœ°æºä»£ç è¿›è¡Œæ„å»º"
}

build() {
  # è·å–é¡¹ç›®æ ¹ç›®å½•ï¼ˆPKGBUILD æ‰€åœ¨ç›®å½•çš„ä¸Šä¸€çº§ï¼‰
  PROJECT_ROOT="$(dirname "$startdir")"
  
  echo "ğŸ“ é¡¹ç›®æ ¹ç›®å½•: $PROJECT_ROOT"
  cd "$PROJECT_ROOT"
  
  echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
  bun install
  
  echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
  cd apps/desktop
  bun run build
  
  echo "ğŸš€ æ„å»º Tauri åº”ç”¨..."
  bun run tauri build -- --bundles deb
}

package() {
  # è·å–é¡¹ç›®æ ¹ç›®å½•
  PROJECT_ROOT="$(dirname "$startdir")"
  cd "$PROJECT_ROOT"
  
  # å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶
  install -Dm755 "apps/desktop/src-tauri/target/release/$pkgname" \
    "$pkgdir/usr/bin/$pkgname"
  
  # å®‰è£…æ¡Œé¢æ–‡ä»¶
  install -Dm644 "aur/$pkgname.desktop" \
    "$pkgdir/usr/share/applications/$pkgname.desktop"
  
  # å®‰è£…å›¾æ ‡
  for size in 32 128 256; do
    if [ -f "apps/desktop/src-tauri/icons/${size}x${size}.png" ]; then
      install -Dm644 "apps/desktop/src-tauri/icons/${size}x${size}.png" \
        "$pkgdir/usr/share/icons/hicolor/${size}x${size}/apps/$pkgname.png"
    fi
  done
  
  # å®‰è£…è®¸å¯è¯
  if [ -f LICENSE ]; then
    install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
  fi
  
  # å®‰è£…æ–‡æ¡£
  if [ -f README.md ]; then
    install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
  fi
}
