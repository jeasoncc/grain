# ZIP 导出功能

## 🎉 新功能

添加了将所有数据导出为 ZIP 压缩包的功能，提供结构化的文件组织方式。

## ✨ 功能特性

### 1. 结构化导出
ZIP 压缩包按照以下结构组织：

```
novel-editor-backup-2024-12-02.zip
├── data.json                    # 完整的 JSON 备份
├── 书籍1/
│   ├── project.json            # 项目信息
│   ├── 第一章/
│   │   ├── chapter.json        # 章节信息
│   │   ├── 场景1.txt          # 场景文本
│   │   ├── 场景1.json         # 场景完整数据
│   │   ├── 场景2.txt
│   │   └── 场景2.json
│   ├── 第二章/
│   │   └── ...
│   ├── 角色/
│   │   ├── 主角.json
│   │   ├── 配角.json
│   │   └── ...
│   └── 世界观/
│       ├── 魔法系统.json
│       ├── 地理设定.json
│       └── ...
└── 书籍2/
    └── ...
```

### 2. 多种文件格式
- **TXT 文件**: 每个场景的纯文本内容，便于阅读
- **JSON 文件**: 完整的数据结构，包含所有元数据
- **文件夹结构**: 按项目→章节→场景组织

### 3. 易于查看和管理
- 解压后可以直接查看文本文件
- 文件夹结构清晰，便于导航
- 可以用任何文本编辑器打开

## 🎯 使用方法

### 方法 1: 通过导出对话框
1. 点击 ActivityBar 的"导出"按钮（下载图标）
2. 在导出对话框中选择"ZIP 压缩包"格式
3. 点击"导出"按钮
4. 等待打包完成
5. 自动下载 ZIP 文件

### 方法 2: 通过代码
```typescript
import { exportAllAsZip, triggerBlobDownload } from "@/services/projects";

// 导出为 ZIP
const zipBlob = await exportAllAsZip();
const filename = `backup-${new Date().toISOString().slice(0, 10)}.zip`;
triggerBlobDownload(filename, zipBlob);
```

## 📦 导出内容

### 包含的数据
- ✅ 所有项目（书籍）
- ✅ 所有章节
- ✅ 所有场景（文本 + 完整数据）
- ✅ 所有角色信息
- ✅ 所有世界观设定
- ✅ 完整的 JSON 备份

### 文件命名
- 自动清理不安全的文件名字符
- 使用下划线替换特殊字符
- 保持文件名可读性

## 🔧 技术实现

### 核心函数

#### `exportAllAsZip()`
```typescript
/**
 * 导出所有数据为 ZIP 文件
 * @returns Blob 对象，可用于下载
 */
export async function exportAllAsZip(): Promise<Blob> {
  const JSZip = (await import("jszip")).default;
  const zip = new JSZip();
  
  // 1. 获取所有数据
  // 2. 创建文件夹结构
  // 3. 添加文件
  // 4. 生成 ZIP
  
  return await zip.generateAsync({ type: "blob" });
}
```

#### `sanitizeFileName()`
```typescript
/**
 * 清理文件名，移除不安全的字符
 */
function sanitizeFileName(name: string): string {
  return name.replace(/[<>:"/\\|?*]/g, "_").trim() || "未命名";
}
```

### 依赖库
- **jszip**: 用于创建 ZIP 文件
- 已在 package.json 中安装

## 💡 使用场景

### 场景 1: 完整备份
```
定期导出 ZIP 备份 → 保存到云盘 → 数据安全
```

### 场景 2: 分享作品
```
导出 ZIP → 发送给编辑/读者 → 他们可以查看文本文件
```

### 场景 3: 版本控制
```
每个重要版本导出 ZIP → 保留历史版本 → 可以回溯
```

### 场景 4: 迁移数据
```
导出 ZIP → 解压查看 → 选择性导入到其他工具
```

## 🆚 与 JSON 导出的对比

| 特性 | JSON 导出 | ZIP 导出 |
|------|-----------|----------|
| 文件大小 | 较小 | 较大 |
| 可读性 | 需要工具 | 直接查看 |
| 结构化 | 单文件 | 文件夹结构 |
| 导入 | 完整导入 | 需要解析 |
| 适用场景 | 完整备份恢复 | 查看和分享 |

## 📊 文件大小估算

假设一本书有：
- 10 个章节
- 每章 10 个场景
- 每场景 2000 字

估算大小：
- TXT 文件: ~200KB
- JSON 文件: ~500KB
- 总计: ~700KB (压缩后约 200-300KB)

## ⚠️ 注意事项

### 1. 文件名限制
- 自动移除不安全字符
- 过长的文件名会被截断
- 空文件名使用"未命名"

### 2. 性能考虑
- 大量数据可能需要几秒钟
- 显示"正在打包数据..."提示
- 异步处理，不阻塞 UI

### 3. 浏览器兼容性
- 现代浏览器都支持
- 需要支持 Blob 和 URL.createObjectURL

## 🚀 未来改进

### 短期计划
- [ ] 支持选择性导出（只导出某些项目）
- [ ] 添加导出进度显示
- [ ] 支持自定义文件夹结构

### 中期计划
- [ ] 支持从 ZIP 导入
- [ ] 支持增量备份
- [ ] 支持加密 ZIP

### 长期计划
- [ ] 云端自动备份
- [ ] 多版本管理
- [ ] 协作功能

## 🐛 故障排除

### 问题 1: 导出失败
**原因**: 数据量过大或浏览器内存不足
**解决**: 尝试分批导出或使用 JSON 格式

### 问题 2: 文件名乱码
**原因**: 特殊字符处理
**解决**: 已自动清理，如仍有问题请反馈

### 问题 3: 下载没有开始
**原因**: 浏览器阻止了下载
**解决**: 检查浏览器下载设置，允许自动下载

## 📚 相关文档

- [导出服务](./src/services/projects.ts)
- [导出对话框](./src/components/blocks/export-dialog.tsx)

## 🎉 总结

ZIP 导出功能提供了一种结构化、易于查看的备份方式：

1. ✅ **结构清晰** - 按项目和章节组织
2. ✅ **易于查看** - 文本文件可直接打开
3. ✅ **完整备份** - 包含所有数据
4. ✅ **便于分享** - 可以发送给他人查看

现在你可以通过导出对话框选择"ZIP 压缩包"格式来导出你的作品了！
