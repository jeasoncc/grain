# 本地测试指南

在发布到 AUR 之前，应该先在本地测试构建和安装。

## 测试方案

### 方案 1：直接构建（推荐先做）

**适用于**：所有 Linux 发行版

这个方案直接构建应用，不打包成 AUR 包，速度更快。

```bash
./scripts/test-local-build.sh
```

**流程**：
1. 检查依赖（bun, rust, cargo）
2. 安装 npm 依赖
3. 构建前端
4. 构建 Tauri 应用
5. 生成 DEB 和 RPM 包
6. 可选：安装 DEB 包测试

**时间**：约 5-10 分钟（首次构建）

**输出**：
- `apps/desktop/src-tauri/target/release/novel-editor` - 二进制文件
- `apps/desktop/src-tauri/target/release/bundle/deb/*.deb` - DEB 包
- `apps/desktop/src-tauri/target/release/bundle/rpm/*.rpm` - RPM 包

### 方案 2：AUR 包构建（Arch Linux 专用）

**适用于**：Arch Linux 或 Manjaro

这个方案模拟 AUR 用户的安装过程，使用 PKGBUILD 构建。

```bash
./scripts/test-aur-local.sh
```

**流程**：
1. 检查 Arch Linux 依赖
2. 创建临时构建目录
3. 使用 PKGBUILD.local 构建
4. 生成 .pkg.tar.zst 包
5. 可选：安装包测试

**时间**：约 10-20 分钟（首次构建）

**输出**：
- `novel-editor-0.1.0-1-x86_64.pkg.tar.zst` - Arch 包

## 详细步骤

### 准备工作

#### 1. 安装基础依赖

**Arch Linux**：
```bash
sudo pacman -S base-devel git rust cargo nodejs patchelf webkit2gtk gtk3 libappindicator-gtk3
```

**Ubuntu/Debian**：
```bash
sudo apt-get install build-essential git curl wget libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
```

**Fedora**：
```bash
sudo dnf install @development-tools git curl wget webkit2gtk4.1-devel libappindicator-gtk3-devel librsvg2-devel patchelf
```

#### 2. 安装 Bun

```bash
curl -fsSL https://bun.sh/install | bash
```

#### 3. 安装 Rust（如果没有）

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

### 测试步骤

#### 步骤 1：直接构建测试

```bash
# 运行构建脚本
./scripts/test-local-build.sh

# 如果成功，会生成：
# - apps/desktop/src-tauri/target/release/novel-editor
# - apps/desktop/src-tauri/target/release/bundle/deb/*.deb
# - apps/desktop/src-tauri/target/release/bundle/rpm/*.rpm
```

#### 步骤 2：测试运行

```bash
# 直接运行二进制
./apps/desktop/src-tauri/target/release/novel-editor

# 或安装 DEB 包（Ubuntu/Debian）
sudo dpkg -i apps/desktop/src-tauri/target/release/bundle/deb/*.deb
novel-editor

# 或安装 RPM 包（Fedora）
sudo rpm -i apps/desktop/src-tauri/target/release/bundle/rpm/*.rpm
novel-editor
```

#### 步骤 3：AUR 包测试（仅 Arch Linux）

```bash
# 运行 AUR 测试脚本
./scripts/test-aur-local.sh

# 如果成功，会生成：
# - novel-editor-0.1.0-1-x86_64.pkg.tar.zst

# 安装测试
sudo pacman -U /tmp/tmp.*/novel-editor-*.pkg.tar.zst

# 运行
novel-editor

# 卸载
sudo pacman -R novel-editor
```

## 常见问题

### Q1: 构建失败 - "bun: command not found"

**解决**：
```bash
curl -fsSL https://bun.sh/install | bash
source ~/.bashrc  # 或 source ~/.zshrc
```

### Q2: 构建失败 - "cargo: command not found"

**解决**：
```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source ~/.cargo/env
```

### Q3: 构建失败 - "webkit2gtk not found"

**Arch Linux**：
```bash
sudo pacman -S webkit2gtk gtk3 libappindicator-gtk3
```

**Ubuntu/Debian**：
```bash
sudo apt-get install libwebkit2gtk-4.1-dev libappindicator3-dev
```

### Q4: 构建很慢

**原因**：首次构建需要下载和编译 Rust 依赖

**解决**：耐心等待，后续构建会快很多（使用缓存）

### Q5: 磁盘空间不足

**需要**：约 3-5 GB 空间

**清理**：
```bash
# 清理 Rust 构建缓存
cargo clean

# 清理 node_modules
rm -rf node_modules apps/*/node_modules
```

### Q6: 内存不足

**需要**：至少 4 GB RAM

**解决**：关闭其他应用，或增加 swap

## 验证清单

构建成功后，验证以下内容：

- [ ] 应用可以启动
- [ ] 可以创建项目
- [ ] 可以创建章节和场景
- [ ] 编辑器可以正常输入
- [ ] 可以保存内容
- [ ] 可以导出文件
- [ ] 搜索功能正常
- [ ] 设置可以保存
- [ ] 主题切换正常
- [ ] 图标显示正常

## 性能测试

```bash
# 检查二进制大小
ls -lh apps/desktop/src-tauri/target/release/novel-editor

# 检查启动时间
time novel-editor

# 检查内存使用
ps aux | grep novel-editor
```

## 下一步

如果所有测试都通过：

1. ✅ 直接构建成功
2. ✅ 应用可以正常运行
3. ✅ AUR 包构建成功（Arch Linux）
4. ✅ 功能验证通过

那么可以准备发布到 AUR：

```bash
# 创建 GitHub Release
git tag -a v0.1.0 -m "Release version 0.1.0"
git push origin v0.1.0

# 发布到 AUR
./scripts/release-aur.sh 0.1.0
```

## 调试技巧

### 查看详细构建日志

```bash
# Tauri 构建
cd apps/desktop
RUST_LOG=debug bun run tauri build

# 查看 Cargo 详细输出
cd apps/desktop/src-tauri
cargo build --release --verbose
```

### 检查依赖

```bash
# 检查 Rust 工具链
rustc --version
cargo --version

# 检查 Bun
bun --version

# 检查系统库
pkg-config --modversion webkit2gtk-4.1
pkg-config --modversion gtk+-3.0
```

### 清理重新构建

```bash
# 清理所有构建产物
rm -rf apps/desktop/dist
rm -rf apps/desktop/src-tauri/target
rm -rf node_modules
rm -rf apps/*/node_modules

# 重新安装依赖
bun install

# 重新构建
./scripts/test-local-build.sh
```

## 总结

**推荐测试流程**：

1. 先运行 `./scripts/test-local-build.sh` 快速测试
2. 验证应用功能
3. 如果在 Arch Linux 上，运行 `./scripts/test-aur-local.sh`
4. 验证 AUR 包安装
5. 一切正常后，准备发布

**预计时间**：
- 首次构建：15-30 分钟
- 后续构建：5-10 分钟
- 功能测试：10-15 分钟
- **总计**：约 30-60 分钟
