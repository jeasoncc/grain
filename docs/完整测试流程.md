# 完整测试流程

## 两步测试法（推荐）

### 第一步：构建应用

```bash
./scripts/test-local-build.sh
```

这会：
- 构建前端和后端
- 生成 DEB 和 RPM 包
- 生成二进制文件

**时间**：5-10 分钟（首次构建）

### 第二步：测试 AUR 包

```bash
./scripts/test-aur-from-binary.sh
```

这会：
- 使用已构建的二进制文件
- 打包成 Arch 包（.pkg.tar.zst）
- 可选：安装测试

**时间**：1-2 分钟（只打包，不编译）

## 详细流程

### 1. 构建应用

```bash
# 运行构建脚本
./scripts/test-local-build.sh

# 预期输出：
# ✅ 依赖检查通过
# ✅ 依赖安装完成
# ✅ 前端构建完成
# ✅ 构建成功！
#
# 📦 生成的包：
# DEB 包：novel-editor_0.1.0_amd64.deb
# RPM 包：novel-editor-0.1.0-1.x86_64.rpm
# 二进制文件：novel-editor
```

### 2. 测试运行

```bash
# 直接运行二进制
./apps/desktop/src-tauri/target/release/novel-editor

# 测试功能：
# - 创建项目
# - 创建章节
# - 编辑内容
# - 保存
# - 搜索
# - 导出
```

### 3. 打包成 AUR 包

```bash
# 运行 AUR 打包脚本
./scripts/test-aur-from-binary.sh

# 预期输出：
# ✅ 找到构建的二进制文件
# ✅ 文件已复制
# ✅ .SRCINFO 已生成
# ✅ 打包成功！
#
# 📦 生成的包：
# novel-editor-0.1.0-1-x86_64.pkg.tar.zst
```

### 4. 安装测试

```bash
# 脚本会询问是否安装，选择 y

# 或手动安装
sudo pacman -U /tmp/tmp.*/novel-editor-*.pkg.tar.zst

# 运行
novel-editor

# 验证安装位置
which novel-editor
# 输出: /usr/bin/novel-editor

ls /usr/share/applications/novel-editor.desktop
# 桌面文件存在

# 卸载
sudo pacman -R novel-editor
```

## 优势

### 为什么这个方法更好？

1. **分离构建和打包**
   - 构建只需要做一次
   - 打包可以快速重复测试

2. **节省时间**
   - 构建：5-10 分钟（一次）
   - 打包：1-2 分钟（可多次）

3. **易于调试**
   - 构建问题和打包问题分开
   - 更容易定位错误

4. **真实模拟**
   - 使用真实的构建产物
   - 验证文件路径和权限

## 完整命令

```bash
# 一键完成所有测试
./scripts/test-local-build.sh && ./scripts/test-aur-from-binary.sh
```

## 验证清单

### 构建验证
- [ ] 前端构建成功（dist 目录存在）
- [ ] Tauri 构建成功（二进制文件存在）
- [ ] DEB 包生成
- [ ] RPM 包生成

### 运行验证
- [ ] 应用可以启动
- [ ] 界面显示正常
- [ ] 可以创建项目
- [ ] 可以编辑内容
- [ ] 可以保存数据
- [ ] 搜索功能正常

### AUR 包验证
- [ ] 打包成功（.pkg.tar.zst 生成）
- [ ] 包内容正确（包含二进制、桌面文件、图标）
- [ ] 可以安装（pacman -U）
- [ ] 安装后可以运行
- [ ] 桌面文件可以启动应用
- [ ] 可以卸载（pacman -R）

## 常见问题

### Q: 第一步构建失败

**检查**：
- Bun 是否安装：`bun --version`
- Rust 是否安装：`cargo --version`
- 系统依赖是否完整：`pkg-config --modversion webkit2gtk-4.1`

**解决**：参考 `docs/本地测试指南.md`

### Q: 第二步打包失败

**检查**：
- 二进制文件是否存在：`ls apps/desktop/src-tauri/target/release/novel-editor`
- makepkg 是否安装：`which makepkg`

**解决**：
```bash
# 安装 makepkg
sudo pacman -S base-devel
```

### Q: 安装后无法运行

**检查**：
- 运行时依赖：`pacman -Q webkit2gtk gtk3 libappindicator-gtk3`
- 权限：`ls -l /usr/bin/novel-editor`

**解决**：
```bash
# 安装运行时依赖
sudo pacman -S webkit2gtk gtk3 libappindicator-gtk3
```

### Q: 桌面文件不显示

**检查**：
```bash
# 更新桌面数据库
sudo update-desktop-database

# 更新图标缓存
sudo gtk-update-icon-cache /usr/share/icons/hicolor
```

## 性能测试

```bash
# 检查包大小
ls -lh /tmp/tmp.*/novel-editor-*.pkg.tar.zst

# 检查安装大小
pacman -Qi novel-editor | grep "Installed Size"

# 检查启动时间
time novel-editor

# 检查内存使用
ps aux | grep novel-editor | grep -v grep
```

## 下一步

如果所有测试都通过：

```bash
# 1. 提交代码
git add .
git commit -m "Release v0.1.0"
git push origin main

# 2. 创建 tag
git tag -a v0.1.0 -m "Release version 0.1.0"
git push origin v0.1.0

# 3. 在 GitHub 创建 Release
# 上传 DEB 和 RPM 包作为附件

# 4. 发布到 AUR
./scripts/release-aur.sh 0.1.0
```

## 总结

**推荐流程**：

```bash
# 步骤 1：构建（5-10 分钟）
./scripts/test-local-build.sh

# 步骤 2：测试运行（5 分钟）
./apps/desktop/src-tauri/target/release/novel-editor

# 步骤 3：打包 AUR（1-2 分钟）
./scripts/test-aur-from-binary.sh

# 步骤 4：安装测试（选择 y）
# 步骤 5：功能验证（10 分钟）
# 步骤 6：卸载清理

# 总时间：约 20-30 分钟
```

**优点**：
- ✅ 快速高效
- ✅ 易于调试
- ✅ 真实模拟
- ✅ 可重复测试

现在你可以开始测试了！🚀
