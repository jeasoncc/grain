name: Publish to openSUSE Build Service

# ä¾èµ– desktop æ„å»ºå®Œæˆï¼Œåªé€šè¿‡ workflow_dispatch è§¦å‘
# desktop å®Œæˆåä¼šè‡ªåŠ¨è§¦å‘æ­¤å·¥ä½œæµ
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.53)'
        required: true
        type: string

jobs:
  publish-obs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Extract version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Creating OBS package for version: $VERSION"

      - name: Install OBS tools
        run: |
          # æ·»åŠ  OBS ä»“åº“
          echo 'deb http://download.opensuse.org/repositories/openSUSE:/Tools/xUbuntu_22.04/ /' | sudo tee /etc/apt/sources.list.d/opensuse-tools.list
          curl -fsSL https://download.opensuse.org/repositories/openSUSE:Tools/xUbuntu_22.04/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/opensuse-tools.gpg > /dev/null
          
          sudo apt-get update
          sudo apt-get install -y osc

      - name: Setup OBS configuration
        env:
          OBS_CONFIG: ${{ secrets.OBS_CONFIG }}
        run: |
          if [ -z "$OBS_CONFIG" ]; then
            echo "âš  OBS_CONFIG not set, creating example config"
            
            mkdir -p ~/.config/osc
            cat > ~/.config/osc/oscrc << EOF
          [general]
          apiurl = https://api.opensuse.org
          
          [https://api.opensuse.org]
          user = your-obs-username
          pass = your-obs-password
          EOF
            
            echo "ğŸ“‹ OBS configuration example created"
            echo "To use OBS, add OBS_CONFIG secret with your ~/.config/osc/oscrc content"
          else
            mkdir -p ~/.config/osc
            echo "$OBS_CONFIG" > ~/.config/osc/oscrc
            echo "âœ… OBS configuration loaded"
          fi

      - name: Verify release exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_URL="https://api.github.com/repos/${{ github.repository }}/releases/tags/desktop-v$VERSION"
          
          echo "ğŸ” Checking release desktop-v$VERSION"
          
          RESPONSE=$(curl -s "$RELEASE_URL")
          if echo "$RESPONSE" | jq -e '.message == "Not Found"' > /dev/null; then
            echo "âŒ Release desktop-v$VERSION not found"
            echo ""
            echo "ğŸ“‹ To fix this:"
            echo "1. Create desktop release first: npm run tag:desktop"
            echo "2. Wait for build to complete"
            echo "3. Then retry OBS publish"
            exit 1
          fi
          
          echo "âœ… Release found"

      - name: Create OBS package structure
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # åˆ›å»ºåŒ…ç›®å½•
          mkdir -p obs-package
          cd obs-package
          
          # åˆ›å»º spec æ–‡ä»¶
          cat > grain.spec << EOF
          #
          # spec file for package grain
          #
          # Copyright (c) 2024 Jeason
          #
          
          Name:           grain
          Version:        $VERSION
          Release:        1
          Summary:        A modern, powerful novel writing application
          License:        MIT
          Group:          Productivity/Text/Editors
          URL:            https://github.com/${{ github.repository }}
          Source0:        https://github.com/${{ github.repository }}/archive/refs/tags/desktop-v%{version}.tar.gz
          BuildRoot:      %{_tmppath}/%{name}-%{version}-build
          
          # Build dependencies
          BuildRequires:  cargo
          BuildRequires:  rust
          BuildRequires:  nodejs
          BuildRequires:  npm
          BuildRequires:  webkit2gtk3-devel
          BuildRequires:  gtk3-devel
          BuildRequires:  libappindicator3-devel
          BuildRequires:  librsvg2-devel
          
          # Runtime dependencies
          Requires:       webkit2gtk3
          Requires:       gtk3
          
          %description
          Novel Editor is a professional writing tool designed specifically for
          novelists and long-form fiction writers. Built with modern technologies,
          it provides a distraction-free writing environment with powerful
          organizational features.
          
          Features include:
          - Rich text editing with Lexical editor
          - Chapter and scene organization
          - Character and world-building tools
          - Export to multiple formats (DOCX, PDF, etc.)
          - Dark/light theme support
          - Offline-first with local storage
          - Cross-platform compatibility
          
          %prep
          %setup -q -n grain-desktop-v%{version}
          
          %build
          # Install Bun
          curl -fsSL https://bun.sh/install | bash
          export PATH="\$HOME/.bun/bin:\$PATH"
          
          # Install dependencies
          bun install
          
          # Build the application
          cd apps/desktop
          bun install
          bun run tauri build
          
          %install
          cd apps/desktop/src-tauri/target/release
          
          # Install binary
          install -D -m 755 grain %{buildroot}%{_bindir}/grain
          
          # Install desktop file
          install -D -m 644 bundle/deb/grain_*_amd64/data/usr/share/applications/grain.desktop \\
              %{buildroot}%{_datadir}/applications/grain.desktop
          
          # Install icons
          for size in 32 128 256; do
              install -D -m 644 ../icons/\${size}x\${size}.png \\
                  %{buildroot}%{_datadir}/icons/hicolor/\${size}x\${size}/apps/grain.png
          done
          
          %files
          %defattr(-,root,root,-)
          %{_bindir}/grain
          %{_datadir}/applications/grain.desktop
          %{_datadir}/icons/hicolor/*/apps/grain.png
          
          %changelog
          * $(date +'%a %b %d %Y') Jeason <xiaomiquan@aliyun.com> - $VERSION-1
          - Update to version $VERSION
          - See https://github.com/${{ github.repository }}/releases/tag/desktop-v$VERSION
          EOF
          
          # åˆ›å»º _service æ–‡ä»¶ï¼ˆç”¨äºè‡ªåŠ¨è·å–æºç ï¼‰
          cat > _service << EOF
          <services>
            <service name="obs_scm">
              <param name="url">https://github.com/${{ github.repository }}.git</param>
              <param name="scm">git</param>
              <param name="revision">desktop-v$VERSION</param>
            </service>
            <service name="tar" mode="buildtime"/>
            <service name="recompress" mode="buildtime">
              <param name="file">*.tar</param>
              <param name="compression">gz</param>
            </service>
          </services>
          EOF
          
          echo "âœ… OBS package structure created"

      - name: Test spec file
        run: |
          cd obs-package
          
          # åŸºæœ¬è¯­æ³•æ£€æŸ¥
          echo "ğŸ§ª Testing spec file syntax..."
          
          # æ£€æŸ¥å¿…éœ€çš„å­—æ®µ
          for field in Name Version Release Summary License; do
            if ! grep -q "^$field:" grain.spec; then
              echo "âŒ Missing required field: $field"
              exit 1
            fi
          done
          
          echo "âœ… Spec file validation passed"

      - name: Submit to OBS
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        env:
          OBS_PROJECT: ${{ secrets.OBS_PROJECT }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          if [ -z "$OBS_PROJECT" ]; then
            echo "âš  OBS_PROJECT not set, skipping submission"
            echo ""
            echo "ğŸ“‹ To submit to OBS:"
            echo "1. Create openSUSE Build Service account"
            echo "2. Create a project (e.g., home:username:grain)"
            echo "3. Add OBS_CONFIG secret with ~/.config/osc/oscrc content"
            echo "4. Add OBS_PROJECT secret (format: home:username:grain)"
            echo "5. Re-run this workflow"
            echo ""
            echo "ğŸ“¦ Files ready for manual submission:"
            ls -la obs-package/
            exit 0
          fi
          
          echo "ğŸ“¤ Submitting to OBS project: $OBS_PROJECT"
          
          # æ£€å‡ºé¡¹ç›®
          osc co "$OBS_PROJECT" || osc mkpac "$OBS_PROJECT" grain
          
          # å¤åˆ¶æ–‡ä»¶
          cp obs-package/* "$OBS_PROJECT/grain/"
          
          cd "$OBS_PROJECT/grain"
          
          # æ·»åŠ æ–‡ä»¶
          osc add *
          
          # æäº¤
          osc ci -m "Update grain to version $VERSION"
          
          echo "âœ… Successfully submitted to OBS!"
          echo ""
          echo "ğŸ‰ Package will be available at:"
          echo "   https://build.opensuse.org/package/show/$OBS_PROJECT/grain"
          echo ""
          echo "ğŸ“¥ Users can install with:"
          echo "   # Add repository"
          echo "   sudo zypper ar https://download.opensuse.org/repositories/$OBS_PROJECT/openSUSE_Tumbleweed/ grain"
          echo "   sudo zypper refresh"
          echo "   sudo zypper install grain"

      - name: Upload OBS artifacts
        uses: actions/upload-artifact@v6
        with:
          name: obs-package
          path: "obs-package/*"
          retention-days: 30

      - name: Create success summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo ""
          echo "ğŸ‰ OBS Package Summary"
          echo "======================"
          echo "âœ… Version: $VERSION"
          echo "âœ… Spec file created"
          echo "âœ… Service file created"
          echo ""
          echo "ğŸ“¦ Installation commands:"
          echo "   sudo zypper ar <repo-url> grain"
          echo "   sudo zypper install grain"
          echo ""
          echo "ğŸ”— Supported distributions:"
          echo "   - openSUSE Tumbleweed"
          echo "   - openSUSE Leap"
          echo "   - SUSE Linux Enterprise"