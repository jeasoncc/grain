name: Build MSIX Package (cargo-packager)

on:
  workflow_dispatch:
  push:
    tags:
      - "desktop-v*.*.*"

jobs:
  build-msix:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4

      # 安装 Rust
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'apps/desktop/src-tauri -> target'

      # 安装 msixbundle-rs
      - name: Install msixbundle
        run: cargo install msixbundle

      # 安装 Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # 安装依赖
      - name: Install dependencies
        run: |
          bun install
          cd apps/desktop
          bun install

      # 构建 Tauri 应用
      - name: Build Tauri app
        working-directory: apps/desktop
        run: bun run tauri build

      # 使用 msixbundle 创建 MSIX
      - name: Create MSIX with msixbundle
        shell: pwsh
        run: |
          Write-Output "使用 msixbundle 创建 MSIX 包..."
          
          # 读取版本号
          $config = Get-Content 'apps/desktop/src-tauri/tauri.conf.json' | ConvertFrom-Json
          $version = $config.version
          
          # 查找可执行文件
          $exePath = "apps/desktop/src-tauri/target/release/novel-editor.exe"
          if (-not (Test-Path $exePath)) {
            Write-Error "未找到可执行文件: $exePath"
            exit 1
          }
          
          Write-Output "✓ 找到可执行文件: $exePath"
          
          # 使用 msixbundle 创建 MSIX
          $outputMsix = "novel-editor_${version}_x64.msix"
          
          msixbundle `
            --exe $exePath `
            --output $outputMsix `
            --name "NovelEditor" `
            --display-name "Novel Editor" `
            --publisher "CN=Lotus" `
            --publisher-display-name "Lotus" `
            --version "$version.0" `
            --description "一个现代化的小说编辑器" `
            --icon "apps/desktop/src-tauri/icons/icon.ico" `
            --logo "apps/desktop/src-tauri/icons/Square150x150Logo.png"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "MSIX 创建失败"
            exit 1
          }
          
          Write-Output "✓ MSIX 创建成功: $outputMsix"
          
          # 显示文件信息
          if (Test-Path $outputMsix) {
            $fileInfo = Get-Item $outputMsix
            Write-Output "文件大小: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
          } else {
            Write-Error "MSIX 文件未生成"
            exit 1
          }

      # 签名 MSIX
      - name: Sign MSIX
        shell: pwsh
        run: |
          Write-Output "签名 MSIX 包..."
          
          # 读取版本号
          $config = Get-Content 'apps/desktop/src-tauri/tauri.conf.json' | ConvertFrom-Json
          $version = $config.version
          $msixFile = "novel-editor_${version}_x64.msix"
          
          if (-not (Test-Path $msixFile)) {
            Write-Error "未找到 MSIX 文件: $msixFile"
            exit 1
          }
          
          # 创建自签名证书
          Write-Output "创建自签名证书..."
          $cert = New-SelfSignedCertificate -Type Custom -Subject "CN=Lotus" `
            -KeyUsage DigitalSignature -FriendlyName "Novel Editor" `
            -CertStoreLocation "Cert:\CurrentUser\My" `
            -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
          
          $password = ConvertTo-SecureString -String "temp123" -Force -AsPlainText
          Export-PfxCertificate -Cert $cert -FilePath "temp-cert.pfx" -Password $password | Out-Null
          Write-Output "✓ 证书创建成功"
          
          # 查找 SignTool
          Write-Output "查找 SignTool..."
          $signTool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter "signtool.exe" -ErrorAction SilentlyContinue | 
                      Where-Object { $_.FullName -like "*\x64\*" } | 
                      Select-Object -First 1 -ExpandProperty FullName
          
          if (-not $signTool) {
            Write-Error "未找到 SignTool"
            exit 1
          }
          
          Write-Output "找到 SignTool: $signTool"
          
          # 签名 MSIX
          Write-Output "正在签名: $msixFile"
          & $signTool sign /fd SHA256 /a /f "temp-cert.pfx" /p "temp123" $msixFile
          
          if ($LASTEXITCODE -eq 0) {
            Write-Output "✓ 签名成功"
          } else {
            Write-Error "✗ 签名失败"
            exit 1
          }

      # 验证 MSIX 文件
      - name: Verify MSIX package
        shell: pwsh
        run: |
          Write-Output "验证 MSIX 包..."
          
          # 读取版本号
          $config = Get-Content 'apps/desktop/src-tauri/tauri.conf.json' | ConvertFrom-Json
          $version = $config.version
          $msixFile = "novel-editor_${version}_x64.msix"
          
          if (Test-Path $msixFile) {
            $fileInfo = Get-Item $msixFile
            Write-Output "✓ MSIX 文件存在"
            Write-Output "  文件名: $($fileInfo.Name)"
            Write-Output "  文件大小: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
            Write-Output "  完整路径: $($fileInfo.FullName)"
          } else {
            Write-Error "MSIX 文件不存在: $msixFile"
            exit 1
          }

      # 上传 MSIX 产物
      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: msix-package
          path: "*.msix"
          if-no-files-found: warn

      # 发布到 GitHub Release
      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: "*.msix"
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
