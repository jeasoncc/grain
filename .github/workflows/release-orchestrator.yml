name: Release Orchestrator

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to release (comma-separated: desktop,flatpak,winget,etc. or "all")'
        required: true
        default: 'all'
        type: string
      version:
        description: 'Version to release (leave empty to use package.json version)'
        required: false
        type: string

jobs:
  orchestrate-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(grep -o '"version":\s*"[^"]*"' package.json | sed 's/.*"version":\s*"\([^"]*\)".*/\1/')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Release version: $VERSION"

      - name: Parse platforms
        id: platforms
        run: |
          PLATFORMS="${{ github.event.inputs.platforms }}"
          
          if [ "$PLATFORMS" = "all" ]; then
            PLATFORMS="desktop,flatpak,winget,chocolatey,scoop,homebrew,ppa,copr,obs,aur,aur-bin,gentoo,snap,web"
          fi
          
          echo "platforms=$PLATFORMS" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Platforms to release: $PLATFORMS"

      - name: Create tags for selected platforms
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PLATFORMS="${{ steps.platforms.outputs.platforms }}"
          
          echo "ğŸ·ï¸ Creating tags for version $VERSION..."
          
          # å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„
          IFS=',' read -ra PLATFORM_ARRAY <<< "$PLATFORMS"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
          if ! git diff-index --quiet HEAD -- 2>/dev/null; then
            echo "âš ï¸ Warning: There are uncommitted changes"
            git status --porcelain
          fi
          
          # åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
          for platform in "${PLATFORM_ARRAY[@]}"; do
            platform=$(echo "$platform" | xargs)  # å»é™¤ç©ºæ ¼
            tag="${platform}-v${VERSION}"
            
            echo "ğŸ“ Creating tag: $tag"
            
            # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
            if git rev-parse "$tag" >/dev/null 2>&1; then
              echo "âš ï¸ Tag $tag already exists, skipping..."
              continue
            fi
            
            # åˆ›å»ºå¸¦æ³¨é‡Šçš„æ ‡ç­¾
            git tag -a "$tag" -m "Release $tag"
            
            # æ¨é€æ ‡ç­¾
            git push origin "$tag"
            
            echo "âœ… Created and pushed tag: $tag"
            
            # æ·»åŠ å°å»¶è¿Ÿé¿å… API é™åˆ¶
            sleep 2
          done

      - name: Monitor release progress
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const platforms = '${{ steps.platforms.outputs.platforms }}'.split(',').map(p => p.trim());
            
            console.log(`ğŸš€ Release orchestration started for version ${version}`);
            console.log(`ğŸ“‹ Platforms: ${platforms.join(', ')}`);
            
            // åˆ›å»ºå‘å¸ƒè·Ÿè¸ª issue
            try {
              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš€ Release v${version} Progress Tracker`,
                body: `# Release v${version} Progress Tracker
            
            This issue tracks the progress of releasing version ${version} across all platforms.
            
            ## ğŸ“‹ Release Status
            
            ${platforms.map(platform => `- [ ] **${platform}**: Pending`).join('\n')}
            
            ## ğŸ”— Useful Links
            
            - [GitHub Actions](https://github.com/${context.repo.owner}/${context.repo.repo}/actions)
            - [Releases](https://github.com/${context.repo.owner}/${context.repo.repo}/releases)
            
            ## ğŸ“Š Timeline
            
            - **Started**: ${new Date().toISOString()}
            - **Estimated completion**: ~20-30 minutes
            
            ---
            
            *This issue will be automatically updated as workflows complete.*`,
                labels: ['release', 'automation']
              });
              
              console.log(`ğŸ“ Created tracking issue: #${issue.number}`);
              
              // ä¿å­˜ issue å·ä¾›åç»­ä½¿ç”¨
              core.setOutput('tracking_issue', issue.number);
              
            } catch (error) {
              console.log('âš ï¸ Could not create tracking issue:', error.message);
            }

      - name: Create release summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PLATFORMS="${{ steps.platforms.outputs.platforms }}"
          
          echo ""
          echo "ğŸ‰ Release Orchestration Summary"
          echo "================================"
          echo "âœ… Version: $VERSION"
          echo "âœ… Platforms: $PLATFORMS"
          echo "âœ… Tags created and pushed"
          echo ""
          echo "â±ï¸ Expected completion time: 20-30 minutes"
          echo ""
          echo "ğŸ“Š Monitor progress at:"
          echo "https://github.com/${{ github.repository }}/actions"
          echo ""
          echo "ğŸ”” You will receive notifications as workflows complete"