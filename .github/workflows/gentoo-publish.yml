name: Publish to Gentoo Overlay

# ä¾èµ– desktop æž„å»ºå®Œæˆï¼Œåªé€šè¿‡ workflow_dispatch è§¦å‘
# desktop å®ŒæˆåŽä¼šè‡ªåŠ¨è§¦å‘æ­¤å·¥ä½œæµ
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.53)'
        required: true
        type: string

jobs:
  publish-gentoo:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Creating Gentoo ebuild for version: $VERSION"

      - name: Install Gentoo tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            git
          
          # å®‰è£… repomanï¼ˆGentoo åŒ…ç®¡ç†å·¥å…·ï¼‰
          pip3 install --user pkgcheck

      - name: Create Gentoo ebuild
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # åˆ›å»º overlay ç»“æž„
          mkdir -p gentoo-overlay/app-editors/grain
          cd gentoo-overlay/app-editors/grain
          
          # åˆ›å»º ebuild æ–‡ä»¶
          cat > "grain-$VERSION.ebuild" << 'EOF'
          # Copyright 2024 Gentoo Authors
          # Distributed under the terms of the GNU General Public License v2
          
          EAPI=8
          
          CRATES="
          	# Cargo dependencies will be listed here
          	# Generated with: cargo ebuild
          "
          
          inherit cargo desktop xdg
          
          DESCRIPTION="A modern, powerful novel writing application for serious writers"
          HOMEPAGE="https://github.com/${{ github.repository }}"
          SRC_URI="
          	https://github.com/${{ github.repository }}/archive/refs/tags/desktop-v${PV}.tar.gz -> ${P}.tar.gz
          	$(cargo_crate_uris)
          "
          
          LICENSE="MIT"
          SLOT="0"
          KEYWORDS="~amd64"
          IUSE=""
          
          DEPEND="
          	dev-libs/glib:2
          	dev-libs/libappindicator:3
          	net-libs/webkit-gtk:4
          	x11-libs/gtk+:3
          "
          RDEPEND="${DEPEND}"
          BDEPEND="
          	net-libs/nodejs[npm]
          	sys-apps/yarn
          "
          
          S="${WORKDIR}/grain-desktop-v${PV}"
          
          src_prepare() {
          	default
          	
          	# Install Node.js dependencies
          	cd apps/desktop || die
          	npm install || die "npm install failed"
          }
          
          src_compile() {
          	cd apps/desktop || die
          	
          	# Build frontend
          	npm run build || die "Frontend build failed"
          	
          	# Build Tauri app
          	cargo_src_compile --manifest-path src-tauri/Cargo.toml
          }
          
          src_install() {
          	cd apps/desktop || die
          	
          	# Install binary
          	dobin src-tauri/target/release/grain
          	
          	# Install desktop file
          	domenu src-tauri/grain.desktop
          	
          	# Install icons
          	local size
          	for size in 32 128 256; do
          		doicon -s ${size} src-tauri/icons/${size}x${size}.png
          	done
          	
          	# Install documentation
          	dodoc ../../README.md
          }
          
          pkg_postinst() {
          	xdg_pkg_postinst
          	
          	elog "Novel Editor has been installed."
          	elog "You can start it from your application menu or by running 'grain'"
          }
          EOF
          
          # åˆ›å»º metadata.xml
          cat > metadata.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE pkgmetadata SYSTEM "https://www.gentoo.org/dtd/metadata.dtd">
          <pkgmetadata>
          	<maintainer type="person">
          		<email>xiaomiquan@aliyun.com</email>
          		<name>Jeason</name>
          	</maintainer>
          	<longdescription lang="en">
          		Novel Editor is a professional writing tool designed specifically for
          		novelists and long-form fiction writers. Built with modern technologies,
          		it provides a distraction-free writing environment with powerful
          		organizational features.
          		
          		Features include rich text editing, chapter organization, character
          		management, and export to multiple formats.
          	</longdescription>
          	<upstream>
          		<remote-id type="github">${{ github.repository }}</remote-id>
          	</upstream>
          </pkgmetadata>
          EOF
          
          # åˆ›å»º Manifest æ–‡ä»¶ï¼ˆæ ¡éªŒå’Œï¼‰
          echo "DIST grain-$VERSION.tar.gz $(curl -sL https://github.com/${{ github.repository }}/archive/refs/tags/desktop-v$VERSION.tar.gz | sha512sum | cut -d' ' -f1) $(curl -sL https://github.com/${{ github.repository }}/archive/refs/tags/desktop-v$VERSION.tar.gz | wc -c)" > Manifest
          
          echo "âœ… Gentoo ebuild created"

      - name: Create overlay metadata
        run: |
          cd gentoo-overlay
          
          # åˆ›å»º overlay é…ç½®
          cat > layout.conf << EOF
          masters = gentoo
          repo-name = grain-overlay
          EOF
          
          # åˆ›å»º repositories.xml
          cat > repositories.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE repositories SYSTEM "/dtd/repositories.dtd">
          <repositories xmlns="" version="1.0">
          	<repo quality="experimental" status="unofficial">
          		<name>grain-overlay</name>
          		<description>Novel Editor Gentoo Overlay</description>
          		<homepage>https://github.com/${{ github.repository }}</homepage>
          		<owner type="person">
          			<email>xiaomiquan@aliyun.com</email>
          			<name>Jeason</name>
          		</owner>
          		<source type="git">https://github.com/${{ github.repository }}-gentoo-overlay.git</source>
          	</repo>
          </repositories>
          EOF
          
          echo "âœ… Overlay metadata created"

      - name: Validate ebuild
        run: |
          cd gentoo-overlay
          
          echo "ðŸ§ª Validating ebuild..."
          
          # åŸºæœ¬è¯­æ³•æ£€æŸ¥
          VERSION="${{ steps.version.outputs.version }}"
          EBUILD_FILE="app-editors/grain/grain-$VERSION.ebuild"
          
          # æ£€æŸ¥å¿…éœ€çš„å˜é‡
          for var in DESCRIPTION HOMEPAGE SRC_URI LICENSE SLOT; do
            if ! grep -q "^$var=" "$EBUILD_FILE"; then
              echo "âŒ Missing required variable: $var"
              exit 1
            fi
          done
          
          # æ£€æŸ¥å¿…éœ€çš„å‡½æ•°
          for func in src_compile src_install; do
            if ! grep -q "^$func()" "$EBUILD_FILE"; then
              echo "âŒ Missing required function: $func"
              exit 1
            fi
          done
          
          echo "âœ… Ebuild validation passed"

      - name: Create installation instructions
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          cat > gentoo-overlay/README.md << EOF
          # Novel Editor Gentoo Overlay
          
          This overlay provides the Novel Editor package for Gentoo Linux.
          
          ## Installation
          
          ### Method 1: Using eselect repository
          
          \`\`\`bash
          # Install eselect-repository if not already installed
          emerge --ask app-eselect/eselect-repository
          
          # Add the overlay
          eselect repository add grain-overlay git https://github.com/${{ github.repository }}-gentoo-overlay.git
          
          # Sync the overlay
          emerge --sync grain-overlay
          
          # Install Novel Editor
          emerge --ask app-editors/grain
          \`\`\`
          
          ### Method 2: Manual overlay setup
          
          \`\`\`bash
          # Create overlay directory
          mkdir -p /var/db/repos/grain-overlay
          
          # Clone the overlay
          git clone https://github.com/${{ github.repository }}-gentoo-overlay.git /var/db/repos/grain-overlay
          
          # Add to repos.conf
          echo '[grain-overlay]
          location = /var/db/repos/grain-overlay
          sync-type = git
          sync-uri = https://github.com/${{ github.repository }}-gentoo-overlay.git
          auto-sync = yes' >> /etc/portage/repos.conf/grain-overlay.conf
          
          # Sync and install
          emerge --sync
          emerge --ask app-editors/grain
          \`\`\`
          
          ## Package Information
          
          - **Category**: app-editors
          - **Package**: grain
          - **Version**: $VERSION
          - **License**: MIT
          - **Keywords**: ~amd64
          
          ## Dependencies
          
          - dev-libs/glib:2
          - dev-libs/libappindicator:3
          - net-libs/webkit-gtk:4
          - x11-libs/gtk+:3
          - net-libs/nodejs[npm]
          - sys-apps/yarn
          
          ## USE Flags
          
          Currently no USE flags are defined for this package.
          
          ## Maintainer
          
          - Jeason <xiaomiquan@aliyun.com>
          
          ## Issues
          
          Please report issues at: https://github.com/${{ github.repository }}/issues
          EOF
          
          echo "âœ… Installation instructions created"

      - name: Upload Gentoo overlay artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gentoo-overlay
          path: "gentoo-overlay/"
          retention-days: 30

      - name: Create success summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo ""
          echo "ðŸŽ‰ Gentoo Overlay Summary"
          echo "========================="
          echo "âœ… Version: $VERSION"
          echo "âœ… Ebuild created"
          echo "âœ… Metadata files created"
          echo "âœ… Installation instructions ready"
          echo ""
          echo "ðŸ“¦ Installation commands:"
          echo "   eselect repository add grain-overlay git <overlay-url>"
          echo "   emerge --sync grain-overlay"
          echo "   emerge --ask app-editors/grain"
          echo ""
          echo "ðŸ”— Next steps:"
          echo "1. Create separate repository for the overlay"
          echo "2. Upload overlay files to the repository"
          echo "3. Submit to Gentoo overlays list (optional)"
          echo ""
          echo "ðŸ“‹ Files ready in artifacts:"
          echo "   - Ebuild file"
          echo "   - Metadata.xml"
          echo "   - Overlay configuration"
          echo "   - Installation instructions"