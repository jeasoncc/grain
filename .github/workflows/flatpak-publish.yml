name: Publish to Flathub

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.36)'
        required: true
        type: string
  push:
    tags:
      - 'flatpak-v*.*.*'   # ä»…åœ¨æ‰“ flatpak tag æ—¶è§¦å‘
  workflow_run:
    workflows: ["Release Desktop App"]
    types:
      - completed

jobs:
  publish-flatpak:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: |
      startsWith(github.ref, 'refs/tags/flatpak-v') || 
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # ä»è§¦å‘çš„ desktop å·¥ä½œæµä¸­æå–ç‰ˆæœ¬
            DESKTOP_TAG="${{ github.event.workflow_run.head_branch }}"
            if [[ "$DESKTOP_TAG" =~ ^desktop-v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
              VERSION="${BASH_REMATCH[1]}"
            else
              # ä» package.json è¯»å–ç‰ˆæœ¬
              VERSION=$(grep -o '"version":\s*"[^"]*"' package.json | sed 's/.*"version":\s*"\([^"]*\)".*/\1/')
            fi
          else
            VERSION=${GITHUB_REF#refs/tags/flatpak-v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Publishing version: $VERSION"
      
      - name: Verify release exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ğŸ” Checking if release desktop-v$VERSION exists..."
          
          # æ£€æŸ¥ GitHub release æ˜¯å¦å­˜åœ¨
          if ! curl -s -f "https://api.github.com/repos/${{ github.repository }}/releases/tags/desktop-v$VERSION" > /dev/null; then
            echo "âŒ Release desktop-v$VERSION not found."
            echo ""
            echo "ğŸ“‹ To fix this issue:"
            echo "1. Run the desktop release workflow first:"
            echo "   npm run tag:desktop"
            echo "   # or manually: git tag desktop-v$VERSION && git push origin desktop-v$VERSION"
            echo ""
            echo "2. Wait for desktop build to complete"
            echo ""
            echo "3. Then retry this Flatpak workflow"
            exit 1
          fi
          
          echo "âœ… Release desktop-v$VERSION found"
      
      - name: Update Flatpak manifest
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ğŸ“ Updating Flatpak manifest to version $VERSION"
          
          # æ›´æ–°ç‰ˆæœ¬å·å’Œ tag
          sed -i "s/tag: v.*/tag: desktop-v$VERSION/" flatpak/com.lotus.NovelEditor.yml
          
          # æ›´æ–° metainfo ä¸­çš„ç‰ˆæœ¬
          sed -i "s/<release version=\".*\"/<release version=\"$VERSION\"/" flatpak/com.lotus.NovelEditor.metainfo.xml
          sed -i "s/date=\".*\"/date=\"$(date +%Y-%m-%d)\"/" flatpak/com.lotus.NovelEditor.metainfo.xml
          
          echo "ğŸ“„ Updated Flatpak manifest:"
          grep -E "tag:|version=" flatpak/com.lotus.NovelEditor.yml flatpak/com.lotus.NovelEditor.metainfo.xml
      
      - name: Install Flatpak
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
      
      - name: Install Flatpak SDK
        run: |
          sudo flatpak install -y flathub org.freedesktop.Platform//23.08
          sudo flatpak install -y flathub org.freedesktop.Sdk//23.08
          sudo flatpak install -y flathub org.freedesktop.Sdk.Extension.node18//23.08
          sudo flatpak install -y flathub org.freedesktop.Sdk.Extension.rust-stable//23.08
      
      - name: Build Flatpak
        run: |
          echo "ğŸ”¨ Building Flatpak package..."
          
          # åˆ›å»ºæ„å»ºç›®å½•
          mkdir -p build-dir
          
          # æ„å»º Flatpak
          flatpak-builder --force-clean --sandbox --user --install-deps-from=flathub \
            --repo=repo build-dir flatpak/com.lotus.NovelEditor.yml
          
          # å¯¼å‡ºä¸º .flatpak æ–‡ä»¶
          flatpak build-export repo build-dir
          flatpak build-bundle repo novel-editor-${{ steps.version.outputs.version }}.flatpak \
            com.lotus.NovelEditor
          
          echo "âœ… Flatpak built successfully"
          ls -la *.flatpak
      
      - name: Test Flatpak installation
        run: |
          echo "ğŸ§ª Testing Flatpak installation..."
          
          # å®‰è£…æµ‹è¯•
          flatpak install --user -y novel-editor-${{ steps.version.outputs.version }}.flatpak
          
          # éªŒè¯å®‰è£…
          if flatpak list --user | grep -q com.lotus.NovelEditor; then
            echo "âœ… Flatpak installation test passed"
          else
            echo "âŒ Flatpak installation test failed"
            exit 1
          fi
      
      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-package
          path: "*.flatpak"
          retention-days: 30
      
      - name: Create Flathub PR preparation
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ğŸ“‹ Flatpak package ready for Flathub submission!"
          echo ""
          echo "Next steps to publish on Flathub:"
          echo "1. Fork https://github.com/flathub/flathub"
          echo "2. Create a new repository: https://github.com/flathub/com.lotus.NovelEditor"
          echo "3. Copy flatpak/com.lotus.NovelEditor.yml to the new repo"
          echo "4. Submit PR to flathub/flathub with the new app"
          echo ""
          echo "Files ready for submission:"
          echo "- flatpak/com.lotus.NovelEditor.yml"
          echo "- flatpak/com.lotus.NovelEditor.desktop"
          echo "- flatpak/com.lotus.NovelEditor.metainfo.xml"
      
      - name: Create success comment
        if: success() && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.version.outputs.version }}';
            
            try {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: `ğŸ‰ **Flatpak æ„å»ºæˆåŠŸï¼**
            
            **ç‰ˆæœ¬ï¼š** ${version}
            **åŒ…åï¼š** com.lotus.NovelEditor
            
            **ä¸‹è½½ï¼š** æŸ¥çœ‹ Actions artifacts
            
            **ä¸‹ä¸€æ­¥ï¼š** æäº¤åˆ° Flathub
            1. Fork https://github.com/flathub/flathub
            2. åˆ›å»ºæ–°ä»“åº“ï¼šcom.lotus.NovelEditor
            3. æäº¤ PR åˆ° Flathub
            
            **å®‰è£…å‘½ä»¤ï¼ˆå‘å¸ƒåï¼‰ï¼š**
            \`\`\`bash
            flatpak install flathub com.lotus.NovelEditor
            \`\`\``
              });
            } catch (error) {
              console.log('æ— æ³•åˆ›å»ºè¯„è®ºï¼Œä½† Flatpak æ„å»ºæˆåŠŸ:', error.message);
            }