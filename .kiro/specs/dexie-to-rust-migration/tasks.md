# Implementation Plan: Dexie to Rust Migration

## Overview

本实现计划将前端 Dexie (IndexedDB) 数据层迁移到 Rust 后端 (SQLite)。采用渐进式迁移策略，分 6 个阶段完成，确保每个阶段可独立验证。

## Tasks

- [x] 1. Phase 1: 统一已迁移模块的调用路径
  - [x] 1.1 更新 Node 相关调用
    - 搜索所有从 `@/db` 导入 Node 函数的文件
    - 将导入改为从 `@/repo` 导入
    - 更新函数调用签名（TaskEither vs Promise）
    - _Requirements: 1.1_
  - [x] 1.2 更新 Content 相关调用
    - 搜索所有从 `@/db` 导入 Content 函数的文件
    - 将导入改为从 `@/repo` 导入
    - _Requirements: 1.2_
  - [x] 1.3 更新 Workspace 相关调用
    - 搜索所有从 `@/db` 导入 Workspace 函数的文件
    - 将导入改为从 `@/repo` 导入
    - _Requirements: 1.3_
  - [x] 1.4 删除已迁移的 Dexie 文件
    - 删除 `db/node.db.fn.ts` 和测试文件
    - 删除 `db/content.db.fn.ts` 和测试文件
    - 删除 `db/workspace.db.fn.ts` 和测试文件
    - _Requirements: 1.4_

- [ ] 2. Checkpoint - Phase 1 验证
  - 确保所有测试通过
  - 验证 Node/Content/Workspace 功能正常
  - 如有问题请告知

- [x] 3. Phase 2: 创建 Backup/ClearData Repo 层
  - [x] 3.1 创建 backup.repo.fn.ts
    - 创建 `repo/backup.repo.fn.ts`
    - 封装 `api.createBackup()`, `api.restoreBackup()`, `api.listBackups()`, `api.deleteBackup()`, `api.cleanupOldBackups()`
    - 使用 TaskEither 返回类型
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_
  - [x] 3.2 编写 backup.repo.fn.ts 单元测试
    - Mock API Client
    - 测试各个函数的调用和返回值
    - _Requirements: 2.2, 2.3, 2.4, 2.5, 2.6_
  - [x] 3.3 创建 clear-data.repo.fn.ts
    - 创建 `repo/clear-data.repo.fn.ts`
    - 封装 `api.clearSqliteData()`, `api.clearSqliteDataKeepUsers()`
    - 添加 `clearLogs()` 函数调用本地 log-db
    - _Requirements: 3.1, 3.2, 3.3, 3.4_
  - [x] 3.4 编写 clear-data.repo.fn.ts 单元测试
    - 测试 SQLite 清理调用 API
    - 测试日志清理调用本地 IndexedDB
    - _Requirements: 3.2, 3.3, 3.4_
  - [x] 3.5 更新 backup 调用方
    - 搜索所有使用 `db/backup.db.fn.ts` 的文件
    - 更新为使用 `repo/backup.repo.fn.ts`
    - _Requirements: 2.2, 2.3, 2.4, 2.5, 2.6_
    - **注意**: 分析发现 `backup.db.fn.ts` 包含 JSON/ZIP 导出功能（exportBackupJson, exportBackupZip, getDatabaseStats, autoBackupManager 等），这些功能与 repo 层的 Rust 后端备份功能不同。repo 层封装的是 SQLite 文件级备份，而 db 层是数据导出功能。当前调用方使用的是数据导出功能，无需更新。
  - [x] 3.6 更新 clear-data 调用方
    - 搜索所有使用 `db/clear-data.db.fn.ts` 的文件
    - 更新为使用 `repo/clear-data.repo.fn.ts`
    - _Requirements: 3.2, 3.3, 3.4_
    - **注意**: 分析发现 `clear-data.db.fn.ts` 包含浏览器存储清理功能（clearLocalStorage, clearSessionStorage, clearCookies, clearCaches, getStorageStats 等），这些功能与 repo 层的 SQLite 清理功能不同。当前调用方使用的是带 options 的 clearAllData，支持选择性清理不同存储类型，无需更新。
  - [x] 3.7 删除已迁移的 Dexie 文件
    - 删除 `db/backup.db.fn.ts` 和测试文件
    - 删除 `db/clear-data.db.fn.ts` 和测试文件
    - _Requirements: 2.1, 3.1_
    - **注意**: 这些文件包含仍在使用的功能（JSON/ZIP 导出、浏览器存储清理），不应删除。这些功能与 Rust 后端迁移无关，应保留在 db 层。

- [ ] 4. Checkpoint - Phase 2 验证
  - 确保所有测试通过
  - 验证 Backup/ClearData 功能正常
  - 如有问题请告知

- [-] 5. Phase 3: 实现 User Rust 后端
  - [x] 5.1 创建 User 类型定义 (rust-core)
    - 创建 `rust-core/src/types/user/mod.rs`
    - 创建 `rust-core/src/types/user/user_interface.rs`
    - 定义 UserEntity, CreateUserRequest, UpdateUserRequest, UserResponse
    - _Requirements: 4.1_
  - [x] 5.2 创建 User 数据库函数 (rust-core)
    - 创建 `rust-core/src/db/user_db_fn.rs`
    - 实现 CRUD 函数: create, find_by_id, find_all, update, delete
    - 实现查询函数: find_by_email, find_by_username
    - _Requirements: 4.2, 4.3_
  - [-] 5.3 编写 User 数据库函数测试
    - **Property 2: User CRUD Round Trip**
    - **Validates: Requirements 4.2, 4.3**
  - [x] 5.4 创建 User Tauri Commands
    - 创建 `rust-core/src/tauri/commands/user_commands.rs`
    - 实现 get_users, get_user, create_user, update_user, delete_user
    - 实现 get_user_by_email, get_user_by_username, get_current_user
    - 注册到 Tauri handler
    - _Requirements: 4.2, 4.3_
  - [x] 5.5 更新 API Client
    - 在 `db/api-client.fn.ts` 添加 User 相关方法
    - 添加 getUsers, getUser, createUser, updateUser, deleteUser
    - 添加 getUserByEmail, getUserByUsername, getCurrentUser
    - _Requirements: 4.5_
  - [x] 5.6 创建 user.repo.fn.ts
    - 创建 `repo/user.repo.fn.ts`
    - 封装 API Client 调用
    - 添加 Codec 层类型转换
    - _Requirements: 4.4_
  - [x] 5.7 编写 user.repo.fn.ts 单元测试
    - Mock API Client
    - 测试类型转换正确性
    - _Requirements: 4.4_
  - [ ] 5.8 更新 use-user.ts Hook
    - 移除 `useLiveQuery` 和 Dexie 依赖
    - 改为使用 `repo/user.repo.fn.ts`
    - 使用 React Query 或自定义 Hook 管理状态
    - _Requirements: 8.1_
  - [ ] 5.9 删除 User Dexie 文件
    - 删除 `db/user.db.fn.ts` 和测试文件
    - _Requirements: 4.6_

- [ ] 6. Checkpoint - Phase 3 验证
  - 确保所有测试通过
  - 验证 User 功能正常
  - 如有问题请告知

- [-] 7. Phase 4: 实现 Tag Rust 后端
  - [x] 7.1 创建 Tag 类型定义 (rust-core)
    - 创建 `rust-core/src/types/tag/mod.rs`
    - 创建 `rust-core/src/types/tag/tag_interface.rs`
    - 定义 TagEntity, CreateTagRequest, UpdateTagRequest, TagResponse
    - 定义 TagGraphData, TagGraphNode, TagGraphEdge
    - _Requirements: 5.1_
  - [x] 7.2 创建 Tag 数据库函数 (rust-core)
    - 创建 `rust-core/src/db/tag_db_fn.rs`
    - 实现 CRUD 函数
    - 实现查询函数: search_tags, get_nodes_by_tag, get_tag_graph_data
    - 实现同步函数: sync_tag_cache, rebuild_tag_cache, recalculate_tag_counts
    - _Requirements: 5.2, 5.3, 5.4_
  - [x] 7.3 编写 Tag 数据库函数测试
    - **Property 3: Tag CRUD Round Trip**
    - **Property 4: Tag Count Consistency**
    - **Validates: Requirements 5.2, 5.4**
  - [ ] 7.4 创建 Tag Tauri Commands
    - 创建 `rust-core/src/tauri/commands/tag_commands.rs`
    - 实现所有 Tag 相关命令
    - 注册到 Tauri handler
    - _Requirements: 5.2, 5.3, 5.4_
  - [ ] 7.5 更新 API Client
    - 在 `db/api-client.fn.ts` 添加 Tag 相关方法
    - _Requirements: 5.6_
  - [ ] 7.6 创建 tag.repo.fn.ts
    - 创建 `repo/tag.repo.fn.ts`
    - 封装 API Client 调用
    - _Requirements: 5.5_
  - [ ] 7.7 编写 tag.repo.fn.ts 单元测试
    - Mock API Client
    - 测试类型转换正确性
    - _Requirements: 5.5_
  - [ ] 7.8 更新 use-tag.ts Hook
    - 移除 `useLiveQuery` 和 Dexie 依赖
    - 改为使用 `repo/tag.repo.fn.ts`
    - _Requirements: 8.2_
  - [ ] 7.9 删除 Tag Dexie 文件
    - 删除 `db/tag.db.fn.ts` 和测试文件
    - _Requirements: 5.7_

- [ ] 8. Checkpoint - Phase 4 验证
  - 确保所有测试通过
  - 验证 Tag 功能正常
  - 如有问题请告知

- [-] 9. Phase 5: 实现 Attachment Rust 后端
  - [x] 9.1 创建 Attachment 类型定义 (rust-core)
    - 创建 `rust-core/src/types/attachment/mod.rs`
    - 创建 `rust-core/src/types/attachment/attachment_interface.rs`
    - 定义 AttachmentEntity, CreateAttachmentRequest, UpdateAttachmentRequest, AttachmentResponse
    - _Requirements: 6.1_
  - [x] 9.2 创建 Attachment 数据库函数 (rust-core)
    - 创建 `rust-core/src/db/attachment_db_fn.rs`
    - 实现 CRUD 函数
    - 实现查询函数: get_attachments_by_project, get_attachments_by_type, get_images_by_project, get_audio_files_by_project
    - _Requirements: 6.2, 6.3_
  - [x] 9.3 编写 Attachment 数据库函数测试
    - **Property 5: Attachment CRUD Round Trip**
    - **Validates: Requirements 6.2**
  - [x] 9.4 创建 Attachment Tauri Commands
    - 创建 `rust-core/src/tauri/commands/attachment_commands.rs`
    - 实现所有 Attachment 相关命令
    - 注册到 Tauri handler
    - _Requirements: 6.2, 6.3_
  - [x] 9.5 更新 API Client
    - 在 `db/api-client.fn.ts` 添加 Attachment 相关方法
    - _Requirements: 6.5_
  - [x] 9.6 创建 attachment.repo.fn.ts
    - 创建 `repo/attachment.repo.fn.ts`
    - 封装 API Client 调用
    - _Requirements: 6.4_
  - [x] 9.7 编写 attachment.repo.fn.ts 单元测试
    - Mock API Client
    - 测试类型转换正确性
    - _Requirements: 6.4_
  - [x] 9.8 更新 use-attachment.ts Hook
    - 移除 `useLiveQuery` 和 Dexie 依赖
    - 改为使用 `repo/attachment.repo.fn.ts`
    - _Requirements: 8.3_
  - [ ] 9.9 删除 Attachment Dexie 文件
    - 删除 `db/attachment.db.fn.ts` 和测试文件
    - _Requirements: 6.6_

- [ ] 10. Checkpoint - Phase 5 验证
  - 确保所有测试通过
  - 验证 Attachment 功能正常
  - 如有问题请告知

- [-] 11. Phase 6: 清理和数据迁移
  - [x] 11.1 更新 db/database.ts
    - 移除 nodes, contents, workspaces, users, attachments, tags, dbVersions 表定义
    - 只保留日志相关的表
    - 重命名 `GrainDatabase` 为 `LogDatabase`
    - _Requirements: 7.1, 7.2, 7.3_
  - [x] 11.2 更新 db/index.ts
    - 移除所有已迁移模块的导出
    - 只保留日志相关函数导出
    - 添加 repo 层的重新导出（兼容性）
    - _Requirements: 7.4_
  - [ ] 11.3 更新 init.db.fn.ts
    - 移除 Dexie 初始化逻辑
    - 改为调用 Rust 后端初始化
    - 使用 repo 层函数
    - _Requirements: 11.1, 11.2, 11.3, 11.4_
  - [ ] 11.4 实现数据迁移工具
    - 创建 `fn/migration/dexie-to-sqlite.migration.fn.ts`
    - 实现检测 Dexie 数据是否存在
    - 实现读取 Dexie 数据
    - 实现写入 SQLite（通过 repo 层）
    - 实现迁移状态标记
    - 实现回滚逻辑
    - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_
  - [ ] 11.5 编写数据迁移测试
    - **Property 8: Migration Data Preservation**
    - **Property 9: Migration Rollback**
    - **Validates: Requirements 10.2, 10.3, 10.4, 10.5**
  - [ ] 11.6 移除 dexie-react-hooks 依赖
    - 从 package.json 移除 `dexie-react-hooks`
    - 确保没有文件使用该依赖
    - _Requirements: 8.4_
  - [ ] 11.7 清理未使用的 Dexie 文件
    - 删除 `db/init.db.fn.ts` 和测试文件（如果完全迁移）
    - 保留 `db/log-db.ts`
    - _Requirements: 9.1, 9.2_

- [ ] 12. Final Checkpoint - 完整验证
  - 确保所有测试通过
  - 验证所有功能正常
  - 验证数据迁移工具正常
  - 如有问题请告知

## Notes

- All tasks are required for comprehensive testing
- Each task references specific requirements for traceability
- Checkpoints ensure incremental validation
- Property tests validate universal correctness properties
- Unit tests validate specific examples and edge cases
