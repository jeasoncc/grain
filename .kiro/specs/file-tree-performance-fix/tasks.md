  # Implementation Plan: File Tree Performance Fix

## Overview

本实现计划聚焦于解决文件树的实际性能问题和用户体验缺陷。通过审查发现：

**已实现的功能**：
- ✅ 文件模板系统（`pipes/content/content.template.fn.ts`）
- ✅ Query Devtools（`main.tsx` 中已配置）
- ✅ 文件创建流程（`flows/templated/`）

**需要修复的问题**：
1. **节点展开卡顿** - 每次展开都要等待后端响应（~500ms）
2. **新建文件不自动定位** - 文件创建后不会自动展开父文件夹并选中
3. **模板内容不显示** - 新建文件的模板内容没有正确显示在编辑器中
4. **Query Devtools 位置** - 需要调整位置避免与 Router Devtools 重叠

**核心策略**：
- 使用乐观更新减少等待时间
- 实现自动展开和定位功能
- 修复编辑器状态同步问题
- 优化 Devtools 布局

---

## Tasks

- [x] 1. 调整 Query Devtools 位置
  - [x] 1.1 更新 main.tsx 中的 Devtools 配置
    - 将 `ReactQueryDevtools` 移到 `position="bottom-left"`
    - 确保与 Router Devtools 不重叠
    - _Requirements: 4.1, 4.2, 4.5_
  
  - [ ]* 1.2 验证 Devtools 显示
    - 启动开发服务器
    - 确认 Query Devtools 显示在左下角
    - 确认 Router Devtools 显示在右下角
    - 确认两者可以同时打开不重叠
    - _Requirements: 4.1, 4.2, 4.3, 4.5_

- [-] 2. 诊断文件创建模板内容问题
  - [x] 2.1 添加调试日志
    - 在 `createFileAsync` 中添加日志输出
    - 记录模板内容生成过程
    - 记录内容保存到数据库的过程
    - 记录编辑器状态更新的过程
    - _Requirements: 3.4, 10.1, 10.2_
  
  - [x] 2.2 检查内容加载流程
    - 检查 `openFileAsync` 是否正确加载内容
    - 检查编辑器状态是否正确设置
    - 检查 Lexical 编辑器是否正确解析 JSON
    - _Requirements: 3.1, 3.2, 3.3, 3.4_
  
  - [x] 2.3 修复内容同步问题
    - 根据诊断结果修复内容加载逻辑
    - 确保模板内容正确传递到编辑器
    - 添加错误处理和降级策略
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_
  
  - [ ]* 2.4 验证修复效果
    - 测试创建文本文件（验证模板显示）
    - 测试创建画布文件（验证画布显示）
    - 测试创建日记文件（验证日期和内容显示）
    - _Requirements: 3.1, 3.2, 3.3_

- [x] 3. 实现文件树自动展开和定位
  - [x] 3.1 创建自动展开工具函数
    - 创建 `utils/file-tree-navigation.util.ts`
    - 实现 `calculateAncestorPath` - 计算从根到目标节点的路径
    - 实现 `expandAncestors` - 展开所有祖先节点
    - 实现 `scrollToNode` - 滚动到目标节点
    - _Requirements: 2.1, 2.3, 2.4_
  
  - [x] 3.2 集成到文件创建流程
    - 在 `FileTreePanelContainer` 的 `handleCreateFile` 中调用自动展开
    - 在文件创建成功后展开祖先节点
    - 选中新创建的节点
    - 滚动到新节点位置
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [x] 3.3 处理边界情况
    - 处理根节点创建（无需展开）
    - 处理深层嵌套节点创建
    - 处理节点不在可见区域的情况
    - _Requirements: 2.1, 2.3_
  
  - [ ]* 3.4 测试自动定位功能
    - 测试在根目录创建文件
    - 测试在折叠的文件夹内创建文件
    - 测试在深层嵌套文件夹内创建文件
    - 验证滚动行为正确
    - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 4. 优化节点展开性能
  - [x] 4.1 分析当前性能瓶颈
    - 添加性能监控日志
    - 测量 `handleToggleCollapsed` 的耗时
    - 测量后端 API 调用的耗时
    - 识别主要的性能瓶颈
    - _Requirements: 1.5, 10.1, 10.2, 10.3_
  
  - [x] 4.2 实现乐观更新策略
    - 创建 `hooks/use-optimistic-collapse.ts`
    - 立即更新 UI 状态（不等待后端）
    - 异步调用后端 API 保存状态
    - 失败时回滚 UI 状态
    - _Requirements: 1.1, 1.2, 1.3, 1.4_
  
  - [x] 4.3 添加防抖优化
    - 对连续的展开/折叠操作进行防抖
    - 设置 300ms 的防抖延迟
    - 确保页面卸载时立即执行
    - _Requirements: 1.5, 6.1, 6.4, 6.5_
  
  - [x] 4.4 集成到 FileTreePanel
    - 在 `FileTreePanelContainer` 中使用乐观更新 Hook
    - 替换现有的 `handleToggleCollapsed` 实现
    - 添加错误处理和用户反馈
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_
  
  - [ ]* 4.5 性能测试和验证
    - 测量优化后的展开/折叠响应时间
    - 验证响应时间 < 50ms
    - 测试快速连续展开多个节点
    - 验证后端请求被正确合并
    - _Requirements: 1.1, 1.5, 6.1_

- [ ] 5. 改进错误处理和用户反馈
  - [ ] 5.1 添加详细的错误日志
    - 在所有关键操作中添加 try-catch
    - 使用 `logger.error` 记录错误详情
    - 包含错误上下文（操作类型、节点 ID 等）
    - _Requirements: 7.1, 10.1, 10.2_
  
  - [ ] 5.2 改进错误提示
    - 使用 `toast.error` 显示具体错误消息
    - 区分网络错误和服务器错误
    - 成功提示 3 秒后自动关闭
    - 错误提示需要手动关闭
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_
  
  - [ ] 5.3 添加性能警告
    - 当操作耗时超过阈值时输出警告
    - 记录慢操作的详细信息
    - 提供性能优化建议
    - _Requirements: 10.3, 10.4_

- [ ] 6. 文档和验证
  - [ ] 6.1 更新代码注释
    - 为所有新增函数添加 JSDoc 注释
    - 说明乐观更新的工作原理
    - 说明自动定位的实现逻辑
  
  - [ ] 6.2 创建性能测试报告
    - 记录优化前后的性能数据
    - 创建性能对比表格
    - 记录到 spec 文档中
    - _Requirements: 10.5_
  
  - [ ]* 6.3 用户验收测试
    - 邀请用户测试新功能
    - 收集反馈
    - 修复发现的问题

---

## Notes

### 任务优先级

**P0 - 必须修复**：
- 任务 2：文件创建模板内容问题（影响核心功能）
- 任务 3：自动展开和定位（严重影响用户体验）
- 任务 4：节点展开性能（严重卡顿）

**P1 - 重要改进**：
- 任务 1：Devtools 位置调整（开发体验）
- 任务 5：错误处理改进（用户体验）

**P2 - 可选优化**：
- 任务 6：文档和验证

### 实施顺序

建议按以下顺序执行：

1. **任务 1** - 快速修复，立即可见效果
2. **任务 2** - 诊断和修复模板内容问题
3. **任务 3** - 实现自动定位功能
4. **任务 4** - 优化展开性能
5. **任务 5** - 改进错误处理
6. **任务 6** - 文档和验证

### 性能目标

| 指标 | 当前 | 目标 | 验证方式 |
|------|------|------|----------|
| 节点展开响应 | ~500ms | < 50ms | 手动测试 + 性能日志 |
| 文件创建到显示 | ~1000ms | < 300ms | 手动测试 + 性能日志 |
| 自动定位完成 | N/A | < 300ms | 手动测试 + 性能日志 |

### 回滚策略

如果新实现出现问题，可以通过以下方式回滚：

1. 保留旧的实现代码（添加 `_legacy` 后缀）
2. 使用 feature flag 控制新旧实现切换
3. 在出现问题时快速切换回旧实现

```typescript
const USE_OPTIMISTIC_UPDATE = import.meta.env.VITE_USE_OPTIMISTIC_UPDATE !== 'false';

if (USE_OPTIMISTIC_UPDATE) {
  // 使用新的乐观更新实现
} else {
  // 使用旧的实现
}
```
---

## Notes

### 任务标记说明

- `[ ]` - 未开始的任务
- `[ ]*` - 可选任务（主要是测试相关）
- `[x]` - 已完成的任务

### 实施顺序

1. **阶段 1: 基础设施**（任务 1-4）
   - 添加 Query Devtools
   - 创建文件模板系统
   - 创建展开状态管理
   - 创建自动定位功能

2. **阶段 2: 核心优化**（任务 5-7）
   - 创建乐观更新 Hook
   - 更新文件创建流程
   - 更新 FileTreePanel 集成

3. **阶段 3: 性能提升**（任务 8-10）
   - 添加防抖优化
   - 改进错误处理
   - 性能优化和验证

4. **阶段 4: 完善和发布**（任务 11-12）
   - 文档和清理
   - 最终验证

### 依赖关系

- 任务 2 必须在任务 6 之前完成（模板系统 → 文件创建）
- 任务 3 必须在任务 7 之前完成（展开状态 → FileTreePanel）
- 任务 4 必须在任务 6 之前完成（自动定位 → 文件创建）
- 任务 5 必须在任务 7 之前完成（乐观更新 → FileTreePanel）
- 任务 8 应该在任务 7 之后完成（防抖 → 乐观更新）

### 测试策略

- 单元测试（`*`标记）是可选的，但强烈推荐
- 集成测试应该在每个阶段完成后执行
- E2E 测试应该在所有功能完成后执行
- 性能测试应该在优化完成后执行

### 性能目标

| 指标 | 当前 | 目标 | 验证方式 |
|------|------|------|----------|
| 节点展开响应 | ~500ms | < 50ms | 手动测试 + 性能监控 |
| 文件创建到显示 | ~1000ms | < 300ms | 手动测试 + 性能监控 |
| 滚动帧率 | ~30fps | 60fps | Chrome DevTools Performance |
| 首次渲染 | ~500ms | < 200ms | Lighthouse |

### 回滚策略

如果新实现出现问题，可以通过以下方式回滚：

1. 保留旧的实现代码（添加 `_legacy` 后缀）
2. 使用 feature flag 控制新旧实现切换
3. 在 `file-tree-panel.container.fn.tsx` 中添加切换逻辑

```typescript
const USE_OPTIMISTIC_UPDATE = import.meta.env.VITE_USE_OPTIMISTIC_UPDATE === 'true';

if (USE_OPTIMISTIC_UPDATE) {
  // 使用新的乐观更新实现
} else {
  // 使用旧的实现
}
```

