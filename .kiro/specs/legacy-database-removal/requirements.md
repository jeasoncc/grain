# 需求文档

## 介绍

Grain 桌面应用的所有数据已完全迁移到 SQLite 后端，但代码中仍存在遗留的 IndexedDB (Dexie) 数据库引用。这些遗留代码不再需要，应该被完全移除并替换为 SQLite API 调用。目标是彻底废弃 Dexie，简化代码库，消除维护负担。

## 术语表

- **遗留数据库代码**: 所有与 IndexedDB/Dexie 相关的代码和引用
- **SQLite后端**: 通过 Tauri API 访问的基于 Rust 的 SQLite 数据库
- **备份系统**: 用于创建和恢复数据备份的系统
- **导出系统**: 用于导出项目数据的系统
- **Wiki系统**: 用于管理带有 wiki 标签内容的系统

## 需求

### 需求 1: 完全移除 Dexie 数据库代码

**用户故事:** 作为开发者，我希望完全移除所有 Dexie/IndexedDB 相关代码，以便简化代码库并消除不必要的复杂性。

#### 验收标准

1. 当清理完成时，系统不应包含任何 `legacy-database.ts` 文件
2. 当清理完成时，系统不应包含任何对 `legacyDatabase` 的引用
3. 当清理完成时，系统不应在 package.json 中包含 Dexie 依赖
4. 当应用运行时，系统不应尝试连接或初始化任何 IndexedDB 数据库

### 需求 2: 替换备份功能中的 Dexie 调用

**用户故事:** 作为用户，我希望备份功能使用 SQLite 后端，以便获得一致的数据访问体验。

#### 验收标准

1. 当创建备份时，备份系统应使用 SQLite `createBackup` API
2. 当恢复备份时，备份系统应使用 SQLite `restoreBackup` API  
3. 当备份操作完成时，系统应提供相同的功能体验
4. 备份系统不应包含任何 Dexie 数据库访问代码

### 需求 3: 替换导出功能中的 Dexie 调用

**用户故事:** 作为用户，我希望项目导出功能使用 SQLite 后端，以便确保导出的数据是最新和准确的。

#### 验收标准

1. 当导出项目时，导出系统应使用 SQLite API 获取所有数据
2. 当导出完成时，系统应生成包含完整项目数据的导出文件
3. 导出系统不应包含任何 Dexie 数据库访问代码
4. 导出的数据格式应保持与之前版本的兼容性

### 需求 4: 处理 Wiki 功能中的 Dexie 调用

**用户故事:** 作为开发者，我希望确定 Wiki 功能的处理方式，以便彻底清除相关的 Dexie 代码。

#### 验收标准

1. 当 Wiki 功能仍需要时，系统应使用 SQLite API 替换所有 Dexie 调用
2. 当 Wiki 功能不再需要时，系统应完全移除相关代码
3. Wiki 系统不应包含任何 Dexie 数据库访问代码
4. 系统不应留下任何孤立的 Wiki 相关遗留代码

### 需求 5: 清理迁移系统中的 Dexie 引用

**用户故事:** 作为开发者，我希望清理迁移系统中的 Dexie 引用，以便简化迁移逻辑。

#### 验收标准

1. 当迁移系统运行时，系统不应尝试访问 Dexie 数据库
2. 当迁移完成时，系统应只依赖 SQLite 后端
3. 迁移系统不应包含任何 Dexie 相关的清理或检查代码
4. 迁移日志应反映仅使用 SQLite 的架构

### 需求 6: 更新所有数据访问为 SQLite API

**用户故事:** 作为开发者，我希望所有数据访问都通过 SQLite API 进行，以便保持一致的数据访问模式。

#### 验收标准

1. 当访问节点数据时，系统应使用 SQLite 节点 API
2. 当访问内容数据时，系统应使用 SQLite 内容 API
3. 当访问工作区数据时，系统应使用 SQLite 工作区 API
4. 当访问用户数据时，系统应使用 SQLite 用户 API

### 需求 7: 清理测试中的 Dexie 模拟

**用户故事:** 作为开发者，我希望移除测试中的所有 Dexie 模拟，以便测试反映真实的 SQLite 使用情况。

#### 验收标准

1. 当运行测试时，测试不应包含任何 Dexie 相关的模拟
2. 当测试数据访问时，测试应验证 SQLite API 的使用
3. 测试套件不应包含任何遗留数据库相关的测试用例
4. 所有测试应在移除 Dexie 后继续通过

### 需求 8: 验证功能完整性

**用户故事:** 作为用户，我希望在移除 Dexie 后所有功能都能正常工作，以便确保应用的稳定性。

#### 验收标准

1. 当应用启动时，所有核心功能应正常工作
2. 当执行数据操作时，操作应成功完成并返回正确结果
3. 当使用备份和导出功能时，功能应按预期工作
4. 应用不应因为缺少 Dexie 而出现任何错误或崩溃