# Grain 函数式数据流架构

本文档定义 Grain 项目的核心架构设计，基于函数式编程理念，实现数据的单向流动。

## 设计哲学

```
对象 = 纯数据（Interface + Builder 构建）
操作 = 纯函数（对数据进行变换）
流动 = 管道（pipe 连接函数）
```

- **数据是水流**：数据像水一样流经管道，每个管道节点是一个纯函数
- **对象无方法**：Interface 和 Builder 只定义数据结构，不包含行为
- **函数是管道**：所有操作都是纯函数，通过 pipe 组合
- **不可变性**：数据一旦创建就不可修改，更新产生新对象

## 数据流架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Grain 函数式数据流架构                                   │
└─────────────────────────────────────────────────────────────────────────────────────┘

                                    ┌─────────────────┐
                                    │     外部世界     │
                                    └────────┬────────┘
                                             │
               ┌─────────────────────────────┼─────────────────────────────┐
               │                             │                             │
               ▼                             ▼                             ▼
      ┌─────────────────┐          ┌─────────────────┐          ┌─────────────────┐
      │    UI 表单       │          │    API 响应     │          │   文件导入      │
      └────────┬────────┘          └────────┬────────┘          └────────┬────────┘
               │                             │                             │
               └─────────────────────────────┼─────────────────────────────┘
                                             │
                                             ▼
                          ┌─────────────────────────────────────┐
                          │           Zod Schema                │
                          │          (运行时校验)                │
                          └──────────────────┬──────────────────┘
                                             │
                               ┌─────────────┴─────────────┐
                               │                           │
                          ❌ 校验失败                   ✅ 校验通过
                               │                           │
                               ▼                           ▼
                    ┌─────────────────┐         ┌─────────────────────────┐
                    │    错误处理      │         │       Builder           │
                    └─────────────────┘         │   → Object.freeze()     │
                                                └────────────┬────────────┘
                                                             │
                                                             ▼
┌────────────────────────────────────────────────────────────────────────────────────┐
│                           Pure Function Pipeline (纯函数管道)                        │
│                                                                                    │
│    ┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐             │
│    │  fn_1    │─────▶│  fn_2    │─────▶│  fn_3    │─────▶│  fn_n    │             │
│    │ (解析)   │ pipe │ (转换)   │ pipe │ (计算)   │ pipe │ (格式化) │             │
│    └──────────┘      └──────────┘      └──────────┘      └──────────┘             │
└────────────────────────────────────────────────────────────────────────────────────┘
                                                             │
                    ┌────────────────────────────────────────┼────────────────────────┐
                    │                                        │                        │
                    ▼                                        ▼                        ▼
     ┌─────────────────────────┐          ┌─────────────────────────┐    ┌───────────────────┐
     │     DB Functions        │          │    Store Functions      │    │ Export Functions  │
     │      (持久化)            │          │     (状态)              │    │    (导出)         │
     └────────────┬────────────┘          └────────────┬────────────┘    └───────────────────┘
                  │                                    │
                  ▼                                    ▼
     ┌─────────────────────────┐          ┌─────────────────────────┐
     │       IndexedDB         │◀────────▶│     Zustand Store       │
     │        (Dexie)          │  persist │      (内存状态)          │
     └─────────────────────────┘          └────────────┬────────────┘
                                                       │
                                                       ▼
                              ┌─────────────────────────────────────────────────────┐
                              │                   React Hooks (响应式绑定)            │
                              └──────────────────────────┬──────────────────────────┘
                                                         │
                                                         ▼
                              ┌─────────────────────────────────────────────────────┐
                              │                   Components (UI 组件)               │
                              └──────────────────────────┬──────────────────────────┘
                                                         │
                                                         └──────────────▶ 回到顶部
```

## 依赖关系图

```
                              types/
                         (Interface + Builder + Schema)
                                 │
                                 │ 被所有层依赖
                                 │
        ┌────────────────────────┼────────────────────────┐
        │                        │                        │
        ▼                        ▼                        ▼
    ┌────────┐              ┌────────┐              ┌────────┐
    │  lib/  │              │  db/   │              │ stores/│
    │  (FP)  │              │(持久化) │              │ (状态) │
    └────────┘              └────────┘              └────────┘
        │                        │                        │
        └────────────────────────┼────────────────────────┘
                                 │
                                 ▼
                          ┌────────────┐
                          │    fn/     │
                          │  (纯函数)   │
                          └────────────┘
                                 │
                                 ▼
                          ┌────────────┐
                          │  actions/  │
                          │ (业务操作)  │
                          └────────────┘
                                 │
                                 ▼
                          ┌────────────┐
                          │   hooks/   │
                          │ (React绑定) │
                          └────────────┘
                                 │
                    ┌────────────┴────────────┐
                    │                         │
                    ▼                         ▼
             ┌────────────┐            ┌────────────┐
             │components/ │            │  routes/   │
             │   (UI)     │            │  (路由)    │
             └────────────┘            └────────────┘
```

### 依赖规则

| 层级 | 可依赖 | 说明 |
|------|--------|------|
| `types/` | 无 | 最底层，纯数据定义 |
| `lib/` | `types/` | 函数式工具 |
| `db/` | `types/` | 持久化操作 |
| `stores/` | `types/` | 运行时状态 |
| `fn/` | `types/`, `lib/`, `db/`, `stores/` | 纯函数管道 |
| `actions/` | `fn/`, `db/`, `stores/`, `types/` | 业务操作 |
| `hooks/` | `actions/`, `fn/`, `stores/` | React 绑定 |
| `components/` | `hooks/`, `types/` | UI 组件 |
| `routes/` | `hooks/`, `components/` | 仅编排，不实现逻辑 |

## 数据三层守卫

| 层级 | 职责 | 时机 |
|------|------|------|
| **Zod Schema** | 运行时校验外部数据 | 数据入口 |
| **Interface** | 编译时类型检查 | 开发时 |
| **Builder** | 构建约束 + 不可变 | 对象创建 |

## 角色对照表

| 概念 | 角色 | 特点 |
|-----|------|-----|
| **Interface** | 水的形状 | 定义数据长什么样 |
| **Builder** | 造水的模具 | 构建符合形状的数据 |
| **Zod Schema** | 守门员 | 运行时校验数据有效性 |
| **Function** | 管道 | 纯净、无副作用、可组合 |
| **Pipe** | 管道连接器 | 让数据流动起来 |
| **Store** | 水池 | 暂存运行时状态 |
| **DB** | 水库 | 持久化存储 |
| **Hook** | 水龙头 | 连接数据和 UI |
| **Component** | 喷泉 | 数据的最终展现 |
