# Grain 函数式数据流架构

本文档定义 Grain 项目的核心架构设计，基于函数式编程理念，实现数据的单向流动。

> 📚 **相关文档**：
> - `#data-flow-frontend` - 前端数据流详解（同步/异步）
> - `#data-flow-backend` - Rust 后端数据流详解
> - `#data-flow-e2e` - 端到端数据流架构

## 设计哲学

```
对象 = 纯数据（Interface + Builder 构建）
操作 = 纯函数（对数据进行变换）
流动 = 管道（pipe 连接函数）
边界 = 入口窄，出口宽
```

- **数据是水流**：数据像水一样流经管道，每个管道节点是一个纯函数
- **对象无方法**：Interface 和 Builder 只定义数据结构，不包含行为
- **函数是管道**：所有操作都是纯函数，通过 pipe 组合
- **不可变性**：数据一旦创建就不可修改，更新产生新对象
- **入口窄出口宽**：严格校验输入（Zod/serde），宽松处理输出（容错、降级）

### 入口窄出口宽原则

```
┌─────────────────────────────────────────────────────────────────┐
│                        入口窄出口宽                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│    外部数据                                                      │
│        │                                                        │
│        ▼                                                        │
│    ┌───────────────────────────────────────┐                   │
│    │           🚪 窄入口（严格校验）          │                   │
│    │                                       │                   │
│    │  - Zod Schema 严格校验                │                   │
│    │  - serde 反序列化 + 自定义校验         │                   │
│    │  - 拒绝不符合规范的数据                │                   │
│    │  - 早失败，快失败                      │                   │
│    │  - 明确的错误信息                      │                   │
│    └───────────────────────────────────────┘                   │
│                        │                                        │
│                        ▼                                        │
│    ┌───────────────────────────────────────┐                   │
│    │           🏭 纯函数处理核心             │                   │
│    │                                       │                   │
│    │  - 类型安全的数据流                    │                   │
│    │  - 不可变数据转换                      │                   │
│    │  - 可预测的行为                        │                   │
│    └───────────────────────────────────────┘                   │
│                        │                                        │
│                        ▼                                        │
│    ┌───────────────────────────────────────┐                   │
│    │           🚀 宽出口（容错输出）          │                   │
│    │                                       │                   │
│    │  - 优雅降级（缺失字段用默认值）         │                   │
│    │  - 兼容多种客户端版本                  │                   │
│    │  - 可选字段灵活处理                    │                   │
│    │  - 向后兼容的响应格式                  │                   │
│    └───────────────────────────────────────┘                   │
│                        │                                        │
│                        ▼                                        │
│    外部消费者                                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**入口窄（Strict Input）**：
- 所有外部输入必须经过严格校验
- 不符合规范的数据立即拒绝，返回明确错误
- 使用 Zod（前端）和 serde + 自定义校验（后端）
- 遵循"早失败"原则，在边界处拦截非法数据

**出口宽（Tolerant Output）**：
- 输出时对缺失数据提供合理默认值
- 响应格式保持向后兼容
- 可选字段使用 `Option<T>` / `T | undefined`
- 允许客户端忽略不认识的字段

---

## 前端依赖关系图

```
                              types/
                         (Interface + Builder + Schema)
                                 │
                                 │ 被所有层依赖
                                 │
        ┌────────────────────────┼────────────────────────┐
        │                        │                        │
        ▼                        ▼                        ▼
    ┌────────┐              ┌────────┐              ┌────────┐
    │  lib/  │              │  repo/ │              │ stores/│
    │  (FP)  │              │(Tauri) │              │ (状态) │
    └────────┘              └────────┘              └────────┘
        │                        │                        │
        └────────────────────────┼────────────────────────┘
                                 │
                                 ▼
                          ┌────────────┐
                          │    fn/     │
                          │  (纯函数)   │
                          └────────────┘
                                 │
                                 ▼
                          ┌────────────┐
                          │  actions/  │
                          │ (业务操作)  │
                          └────────────┘
                                 │
                                 ▼
                          ┌────────────┐
                          │   hooks/   │
                          │ (React绑定) │
                          └────────────┘
                                 │
                    ┌────────────┴────────────┐
                    │                         │
                    ▼                         ▼
             ┌────────────┐            ┌────────────┐
             │components/ │            │  routes/   │
             │   (UI)     │            │  (路由)    │
             └────────────┘            └────────────┘
```

### 前端依赖规则

| 层级 | 可依赖 | 说明 |
|------|--------|------|
| `types/` | 无 | 最底层，纯数据定义 |
| `lib/` | `types/` | 函数式工具 |
| `repo/` | `types/` | Tauri invoke 调用 |
| `stores/` | `types/` | 运行时状态 |
| `fn/` | `types/`, `lib/`, `repo/`, `stores/` | 纯函数管道 |
| `actions/` | `fn/`, `repo/`, `stores/`, `types/` | 业务操作 |
| `hooks/` | `actions/`, `fn/`, `stores/` | React 绑定 |
| `components/` | `hooks/`, `types/` | UI 组件 |
| `routes/` | `hooks/`, `components/` | 仅编排，不实现逻辑 |

---

## 数据三层守卫

| 层级 | 职责 | 时机 |
|------|------|------|
| **Zod Schema** | 运行时校验外部数据 | 数据入口 |
| **Interface** | 编译时类型检查 | 开发时 |
| **Builder** | 构建约束 + 不可变 | 对象创建 |

---

## 角色对照表

| 概念 | 角色 | 特点 |
|-----|------|-----|
| **Interface** | 水的形状 | 定义数据长什么样 |
| **Builder** | 造水的模具 | 构建符合形状的数据 |
| **Zod Schema** | 守门员 | 运行时校验数据有效性 |
| **Function** | 管道 | 纯净、无副作用、可组合 |
| **Pipe** | 管道连接器 | 让数据流动起来 |
| **Store** | 水池 | 暂存运行时状态 |
| **DB** | 水库 | 持久化存储（SQLite） |
| **Hook** | 水龙头 | 连接数据和 UI |
| **Component** | 喷泉 | 数据的最终展现 |

---

## 前后端数据流对照

| 前端 (TypeScript) | 后端 (Rust) | 说明 |
|------------------|-------------|------|
| `Zod Schema` | `serde Deserialize` | 运行时数据校验 |
| `Interface` | `Struct` | 编译时类型定义 |
| `Builder` | `Builder` / `new()` | 对象构建 |
| `*.fn.ts` | `*_fn.rs` | 纯函数文件 |
| `pipe()` | `?` + `map()` | 函数组合 |
| `TaskEither` | `Result<T, AppError>` | 错误处理 |
| `Zustand Store` | (无对应) | 前端状态管理 |
| `React Hooks` | (无对应) | 前端响应式绑定 |
| `repo/*.repo.fn.ts` | `db/*_db_fn.rs` | 数据访问层 |

---

## 角色对照表（前后端统一）

| 概念 | 前端角色 | 后端角色 | 特点 |
|-----|---------|---------|-----|
| **数据形状** | Interface | Struct | 定义数据长什么样 |
| **构建器** | Builder | Builder/new() | 构建符合形状的数据 |
| **守门员** | Zod Schema | serde | 运行时校验数据有效性 |
| **管道** | Function (*.fn.ts) | Function (*_fn.rs) | 纯净、无副作用、可组合 |
| **连接器** | pipe() | ? + map() | 让数据流动起来 |
| **水库** | Tauri invoke | SQLite | 持久化存储 |
| **错误容器** | TaskEither | Result<T, E> | 错误传递 |
| **边界** | Repo (invoke) | Warp/Tauri | 数据入口和出口 |
