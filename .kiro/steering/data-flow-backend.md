---
inclusion: manual
---

# Rust åç«¯æ•°æ®æµè¯¦è§£

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° Rust åç«¯çš„æ•°æ®æµæ¶æ„å’Œç»Ÿä¸€ API è®¾è®¡ã€‚

> ğŸ“š **ç›¸å…³æ–‡æ¡£**ï¼š
> - `architecture.md` - æ ¸å¿ƒæ¶æ„è®¾è®¡å“²å­¦
> - `#data-flow-frontend` - å‰ç«¯æ•°æ®æµè¯¦è§£
> - `#data-flow-e2e` - ç«¯åˆ°ç«¯æ•°æ®æµ

---

## Rust åç«¯ç»Ÿä¸€æ¶æ„

### è®¾è®¡å“²å­¦

```
æ ¸å¿ƒé€»è¾‘ = çº¯å‡½æ•°ï¼ˆrust-coreï¼‰
è¾¹ç•Œé€‚é… = å®ç”Ÿæˆï¼ˆé›¶æ‰‹å†™ï¼‰
ä¸¤ç«¯åˆä¸€ = å•ä¸€çœŸç›¸æº
```

- **çº¯å‡½æ•°æ ¸å¿ƒ**ï¼šæ‰€æœ‰ä¸šåŠ¡é€»è¾‘åœ¨ `rust-core` ä¸­ä»¥çº¯å‡½æ•°å½¢å¼å®šä¹‰
- **è¾¹ç•Œæ˜¯å™ªéŸ³**ï¼šHTTP/IPC åªæ˜¯æ•°æ®çš„å…¥å£å’Œå‡ºå£ï¼Œä¸åº”åŒ…å«é€»è¾‘
- **å®æ¶ˆé™¤é‡å¤**ï¼šé€šè¿‡å£°æ˜å¼å®è‡ªåŠ¨ç”Ÿæˆ Warp handlers å’Œ Tauri commands
- **ä¸€æ¬¡ä¿®æ”¹ï¼Œä¸¤ç«¯ç”Ÿæ•ˆ**ï¼šä¿®æ”¹ `rust-core` è‡ªåŠ¨å½±å“ Web API å’Œæ¡Œé¢åº”ç”¨

---

## Rust åç«¯æ•°æ®æµæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Rust åç«¯ç»Ÿä¸€æ¶æ„                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚    å‰ç«¯è¯·æ±‚      â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                  â”‚                  â”‚
                    â–¼                  â–¼                  â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  Web Browser  â”‚  â”‚ Tauri Desktop â”‚  â”‚  Mobile App   â”‚
           â”‚   (fetch)     â”‚  â”‚   (invoke)    â”‚  â”‚   (fetch)     â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                  â”‚                  â”‚
                   â–¼                  â–¼                  â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
           â”‚  Warp Server  â”‚  â”‚ Tauri Runtime â”‚         â”‚
           â”‚  (HTTP è¾¹ç•Œ)   â”‚  â”‚  (IPC è¾¹ç•Œ)   â”‚         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                   â”‚                  â”‚                  â”‚
                   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
                   â”‚    â”‚                           â”‚    â”‚
                   â–¼    â–¼                           â–¼    â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                                                     â”‚
           â”‚              ğŸ¦€ rust-core (çº¯å‡½æ•°æ ¸å¿ƒ)                â”‚
           â”‚                                                     â”‚
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚  â”‚              api/ (API ç«¯ç‚¹å®šä¹‰)              â”‚   â”‚
           â”‚  â”‚                                             â”‚   â”‚
           â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
           â”‚  â”‚  â”‚Workspaceâ”‚  â”‚  Node   â”‚  â”‚ Content â”‚     â”‚   â”‚
           â”‚  â”‚  â”‚Endpointsâ”‚  â”‚Endpointsâ”‚  â”‚Endpointsâ”‚     â”‚   â”‚
           â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â”‚   â”‚
           â”‚  â”‚       â”‚            â”‚            â”‚           â”‚   â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚          â”‚            â”‚            â”‚               â”‚
           â”‚          â–¼            â–¼            â–¼               â”‚
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚  â”‚              fn/ (çº¯å‡½æ•°ç®¡é“)                 â”‚   â”‚
           â”‚  â”‚                                             â”‚   â”‚
           â”‚  â”‚  Input â”€â”€â–¶ validate â”€â”€â–¶ transform â”€â”€â–¶ Output â”‚   â”‚
           â”‚  â”‚                                             â”‚   â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                        â”‚                           â”‚
           â”‚                        â–¼                           â”‚
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚  â”‚              db/ (æ•°æ®åº“æ“ä½œ)                 â”‚   â”‚
           â”‚  â”‚                                             â”‚   â”‚
           â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
           â”‚  â”‚  â”‚ create â”‚  â”‚  read  â”‚  â”‚ update â”‚        â”‚   â”‚
           â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
           â”‚  â”‚                                             â”‚   â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                        â”‚                           â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚     SQLite      â”‚
                          â”‚   (æŒä¹…åŒ–å­˜å‚¨)   â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API ç«¯ç‚¹å®šä¹‰æ¨¡å¼

```rust
// rust-core/src/api/mod.rs

/// API ç«¯ç‚¹ trait - æ‰€æœ‰ç«¯ç‚¹çš„ç»Ÿä¸€æŠ½è±¡
pub trait ApiEndpoint: Send + Sync {
    /// è¾“å…¥ç±»å‹ï¼ˆè¯·æ±‚å‚æ•°ï¼‰
    type Input: DeserializeOwned + Send;
    /// è¾“å‡ºç±»å‹ï¼ˆå“åº”æ•°æ®ï¼‰
    type Output: Serialize + Send;
    
    /// æ‰§è¡Œç«¯ç‚¹é€»è¾‘ - çº¯å‡½æ•°ï¼Œåªä¾èµ– db å’Œ input
    fn execute(
        db: &DatabaseConnection,
        input: Self::Input,
    ) -> impl Future<Output = AppResult<Self::Output>> + Send;
}

// å…·ä½“ç«¯ç‚¹å®ç°
pub struct GetWorkspaces;
impl ApiEndpoint for GetWorkspaces {
    type Input = ();
    type Output = Vec<WorkspaceResponse>;
    
    async fn execute(db: &DatabaseConnection, _: ()) -> AppResult<Self::Output> {
        workspace_db_fn::find_all(db).await
    }
}
```

---

## å®ç”Ÿæˆè¾¹ç•Œä»£ç 

```rust
// rust-core/src/macros.rs

/// ç”Ÿæˆ Warp handlers
#[macro_export]
macro_rules! warp_routes {
    ($db:expr, $($endpoint:ty => $method:ident $path:literal),* $(,)?) => {{
        use warp::Filter;
        let db = std::sync::Arc::new($db);
        
        $(
            let route = warp::path!($path)
                .and(warp::$method())
                .and(with_db(db.clone()))
                .and_then(|db| async move {
                    <$endpoint>::execute(&db, ()).await
                        .map(|r| warp::reply::json(&r))
                        .map_err(|e| warp::reject::custom(e))
                });
        )*
        
        // ç»„åˆæ‰€æœ‰è·¯ç”±
        routes
    }};
}

/// ç”Ÿæˆ Tauri commands
#[macro_export]
macro_rules! tauri_commands {
    ($($endpoint:ty => $name:ident),* $(,)?) => {
        $(
            #[tauri::command]
            pub async fn $name(
                db: tauri::State<'_, DatabaseConnection>,
                input: <$endpoint as ApiEndpoint>::Input,
            ) -> Result<<$endpoint as ApiEndpoint>::Output, String> {
                <$endpoint>::execute(&db, input)
                    .await
                    .map_err(|e| e.to_string())
            }
        )*
    };
}
```

---

## æœ€ç»ˆä½¿ç”¨æ–¹å¼

```rust
// apps/api-rust/src/main.rs - Warp æœåŠ¡å™¨
#[tokio::main]
async fn main() {
    let db = rust_core::db::connect().await.unwrap();
    
    let routes = rust_core::warp_routes!(db,
        GetWorkspaces => get "api/workspaces",
        GetWorkspace => get "api/workspaces/{id}",
        CreateWorkspace => post "api/workspaces",
        // ... å…¶ä»–ç«¯ç‚¹
    );
    
    warp::serve(routes).run(([127, 0, 0, 1], 3030)).await;
}

// apps/desktop/src-tauri/src/lib.rs - Tauri åº”ç”¨
rust_core::tauri_commands!(
    GetWorkspaces => get_workspaces,
    GetWorkspace => get_workspace,
    CreateWorkspace => create_workspace,
    // ... å…¶ä»–ç«¯ç‚¹
);

fn main() {
    tauri::Builder::default()
        .invoke_handler(tauri::generate_handler![
            get_workspaces,
            get_workspace,
            create_workspace,
        ])
        .run(tauri::generate_context!())
        .unwrap();
}
```

---

## å±‚çº§èŒè´£

| å±‚çº§ | ä½ç½® | èŒè´£ |
|------|------|------|
| **api/** | `rust-core/src/api/` | API ç«¯ç‚¹å®šä¹‰ï¼Œå®ç° `ApiEndpoint` trait |
| **fn/** | `rust-core/src/fn/` | çº¯å‡½æ•°ç®¡é“ï¼Œä¸šåŠ¡é€»è¾‘è½¬æ¢ |
| **db/** | `rust-core/src/db/` | æ•°æ®åº“ CRUD æ“ä½œ |
| **types/** | `rust-core/src/types/` | ç±»å‹å®šä¹‰ï¼ˆRequest/Response/Entityï¼‰ |
| **macros/** | `rust-core/src/macros.rs` | å®å®šä¹‰ï¼Œç”Ÿæˆè¾¹ç•Œä»£ç  |

---

## äº‹åŠ¡æ”¯æŒ

```rust
// éœ€è¦äº‹åŠ¡çš„ç«¯ç‚¹
pub struct CreateNodeWithContent;
impl ApiEndpoint for CreateNodeWithContent {
    type Input = CreateNodeRequest;
    type Output = NodeResponse;
    
    async fn execute(db: &DatabaseConnection, input: Self::Input) -> AppResult<Self::Output> {
        // å¼€å¯äº‹åŠ¡
        let txn = db.begin().await?;
        
        // 1. åˆ›å»ºèŠ‚ç‚¹
        let node = node_db_fn::create(&txn, &input).await?;
        
        // 2. åˆ›å»ºå†…å®¹ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if let Some(content) = input.initial_content {
            content_db_fn::create(&txn, &node.id, &content).await?;
        }
        
        // 3. æäº¤äº‹åŠ¡
        txn.commit().await?;
        
        Ok(node.into())
    }
}
```

---

## è§’è‰²å¯¹ç…§è¡¨ï¼ˆRust åç«¯ï¼‰

| æ¦‚å¿µ | è§’è‰² | ç‰¹ç‚¹ |
|-----|------|-----|
| **ApiEndpoint** | æ°´é—¸ | å®šä¹‰æ•°æ®å¦‚ä½•è¿›å‡ºç³»ç»Ÿ |
| **Input/Output** | æ°´çš„å½¢çŠ¶ | è¯·æ±‚å’Œå“åº”çš„ç±»å‹çº¦æŸ |
| **execute()** | æ°´å¤„ç†å‚ | çº¯å‡½æ•°ï¼Œå¤„ç†æ•°æ®æµ |
| **db/** | æ°´åº“ | æŒä¹…åŒ–å­˜å‚¨ |
| **fn/** | ç®¡é“ | æ•°æ®è½¬æ¢å’ŒéªŒè¯ |
| **å®** | åˆ†æµå™¨ | å°†æ°´æµå¯¼å‘ä¸åŒå‡ºå£ï¼ˆHTTP/IPCï¼‰ |
| **Warp/Tauri** | å‡ºæ°´å£ | è¾¹ç•Œé€‚é…ï¼Œä¸å«é€»è¾‘ |
